;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="31acdf87-c12c-b919-c458-2d70f4a17688")}catch(e){}}();
(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,540901,e=>{"use strict";var a,t=e.i(478902),s=e.i(389959);e.i(128328);var i=e.i(158639),r=e.i(167892),n=e.i(540203),l=e.i(912793),o=e.i(265735),d=e.i(843778),c=e.i(902858),u=e.i(388019);let m=(0,u.default)("CreditCard",[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]]);var p=e.i(479232),h=e.i(355901);e.i(869176);var g=e.i(461470),x=e.i(555167);e.i(464411);var y=e.i(520220),f=e.i(896975),j=e.i(40892),b=e.i(38429),_=e.i(234745);async function v({slug:e,hcaptchaToken:a}){let{data:t,error:s}=await (0,_.post)("/platform/organizations/{slug}/payments/setup-intent",{params:{path:{slug:e}},body:{hcaptchaToken:a}});return s&&(0,_.handleError)(s),t}let S=({onSuccess:e,onError:a,...t}={})=>(0,b.useMutation)({mutationFn:e=>v(e),async onSuccess(a,t,s){await e?.(a,t,s)},async onError(e,t,s){void 0===a?h.toast.error(`Failed to setup intent: ${e.message}`):a(e,t,s)},...t});var N=e.i(10429),C=e.i(356003),w=e.i(269273),P=e.i(711950),T=e.i(242882),A=e.i(86086),E=e.i(2579);async function I({slug:e},a){if(!e)throw Error("slug is required");let{data:t,error:s}=await (0,_.get)("/platform/organizations/{slug}/customer",{params:{path:{slug:e}},signal:a});return s&&(0,_.handleError)(s),t}let k=({slug:e},{enabled:a=!0,...t}={})=>{let{can:s}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.BILLING_READ,"stripe.customer",void 0,{organizationSlug:e});return(0,T.useQuery)({queryKey:P.organizationKeys.customerProfile(e),queryFn:({signal:a})=>I({slug:e},a),enabled:A.IS_PLATFORM&&a&&s&&void 0!==e,...t})};async function M({slug:e,address:a,billing_name:t}){if(!e)return console.error("Slug is required");let{data:s,error:i}=await (0,_.put)("/platform/organizations/{slug}/customer",{params:{path:{slug:e}},body:{address:null!=a?a:void 0,billing_name:t}});if(i)throw(0,_.handleError)(i);return s}let L=({onSuccess:e,onError:a,...t}={})=>{let s=(0,C.useQueryClient)();return(0,b.useMutation)({mutationFn:e=>M(e),async onSuccess(a,t,i){let{address:r,slug:n,billing_name:l}=t;s.setQueriesData({queryKey:P.organizationKeys.customerProfile(n)},e=>e?{...e,billing_name:l,address:r}:e),await e?.(a,t,i)},async onError(e,t,s){void 0===a?h.toast.error(`Failed to update customer profile: ${e.message}`):a(e,t,s)},...t})};async function F({slug:e,paymentMethodId:a}){if(!e)throw Error("Slug is required");let{data:t,error:s}=await (0,_.put)("/platform/organizations/{slug}/payments/default",{body:{payment_method_id:a},params:{path:{slug:e}}});if(s)throw(0,_.handleError)(s);return t}let D=({onSuccess:e,onError:a,...t}={})=>{let s=(0,C.useQueryClient)();return(0,b.useMutation)({mutationFn:e=>F(e),async onSuccess(a,t,i){let{slug:r,paymentMethodId:n}=t;s.setQueriesData({queryKey:P.organizationKeys.paymentMethods(r)},e=>e?{...e,defaultPaymentMethodId:n,data:e.data.map(e=>({...e,is_default:e.id===n}))}:e),await e?.(a,t,i)},async onError(e,t,s){void 0===a?h.toast.error(`Failed to mark payment method as default: ${e.message}`):a(e,t,s)},...t})};async function z({slug:e},a){if(!e)throw Error("slug is required");let{data:t,error:s}=await (0,_.get)("/platform/organizations/{slug}/tax-ids",{params:{path:{slug:e}},signal:a});if(s)throw(0,_.handleError)(s);return t.tax_id}let R=({slug:e},{enabled:a=!0,...t}={})=>{let{can:s}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.BILLING_READ,"stripe.tax_ids");return(0,T.useQuery)({queryKey:P.organizationKeys.taxId(e),queryFn:({signal:a})=>z({slug:e},a),enabled:a&&void 0!==e&&s,...t})};async function O({slug:e,taxId:a}){if(!e)throw Error("Slug is required");if(null!=a){let{data:t,error:s}=await (0,_.put)("/platform/organizations/{slug}/tax-ids",{params:{path:{slug:e}},body:{type:a.type,value:a.value,country:a.country}});return s&&(0,_.handleError)(s),t}{let{data:a,error:t}=await (0,_.del)("/platform/organizations/{slug}/tax-ids",{params:{path:{slug:e}},headers:{Version:"2"}});return t&&(0,_.handleError)(t),a}}let U=({onSuccess:e,onError:a,...t}={})=>{let s=(0,C.useQueryClient)();return(0,b.useMutation)({mutationFn:e=>O(e),async onSuccess(a,t,i){let{slug:r}=t;s.setQueryData(P.organizationKeys.taxId(r),a.tax_id),await e?.(a,t,i)},async onError(e,t,s){void 0===a?h.toast.error(`Failed to update tax id: ${e.message}`):a(e,t,s)},...t})};var B=e.i(822574),q=e.i(837710),$=e.i(34411),K=e.i(9679),Q=e.i(108151);let Y=({onCancel:e,onConfirm:a})=>{let{data:i}=(0,o.useSelectedOrganizationQuery)(),{data:r,isPending:n}=k({slug:i?.slug}),[l,d]=(0,s.useState)(!1),[c,u]=(0,s.useState)(!0),[m,p]=(0,s.useState)(!0),g=(0,C.useQueryClient)(),{mutateAsync:x}=D(),{mutateAsync:y}=L(),{mutateAsync:f}=U(),{data:b,isPending:_}=R({slug:i?.slug}),v=(0,s.useRef)(null),S=async e=>{e.preventDefault(),d(!0),void 0!==document&&document.body.classList.add("!pointer-events-auto");let t=await v.current?.confirmSetup();if(t){if(c&&i&&"string"==typeof t.setupIntent?.payment_method)try{await x({slug:i.slug,paymentMethodId:t.setupIntent.payment_method}),await g.invalidateQueries({queryKey:P.organizationKeys.paymentMethods(i.slug)}),g.setQueriesData({queryKey:P.organizationKeys.paymentMethods(i.slug)},e=>e?{...e,defaultPaymentMethodId:t.setupIntent.payment_method,data:e.data.map(e=>({...e,is_default:e.id===t.setupIntent.payment_method}))}:e)}catch(e){h.toast.error("Failed to set payment method as default")}else i&&await g.invalidateQueries({queryKey:P.organizationKeys.paymentMethods(i.slug)});if(m)try{t.address&&(!(0,B.default)(t.address,r?.address)||r?.billing_name!==t.customerName)&&await y({slug:i?.slug,billing_name:t.customerName,address:t.address}),t.taxId&&!(0,B.default)(t.taxId,b)&&await f({taxId:t.taxId,slug:i?.slug})}catch(e){h.toast.error("Failed to update billing address")}d(!1),a()}else d(!1);void 0!==document&&document.body.classList.remove("!pointer-events-auto")};return n||_?(0,t.jsx)(j.Modal.Content,{children:(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(Q.ShimmeringLoader,{}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-3/4"}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-1/2"}),(0,t.jsx)(Q.ShimmeringLoader,{}),(0,t.jsx)(Q.ShimmeringLoader,{}),(0,t.jsx)(Q.ShimmeringLoader,{})]})}):(0,t.jsxs)("div",{children:[(0,t.jsxs)(j.Modal.Content,{className:`transition ${l?"pointer-events-none opacity-75":"opacity-100"}`,children:[(0,t.jsx)(w.NewPaymentMethodElement,{readOnly:l,email:i?.billing_email,currentAddress:r?.address,customerName:r?.billing_name,currentTaxId:b,ref:v}),(0,t.jsxs)("div",{className:"flex items-center gap-x-2 mt-4 mb-2",children:[(0,t.jsx)($.Checkbox_Shadcn_,{id:"save-as-default",checked:c,onCheckedChange:e=>{"boolean"==typeof e&&u(e)}}),(0,t.jsx)(K.Label_Shadcn_,{htmlFor:"save-as-default",className:"text-foreground-light",children:"Save as default payment method"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-x-2 mt-4 mb-2",children:[(0,t.jsx)($.Checkbox_Shadcn_,{id:"is-primary-billing-address",checked:m,onCheckedChange:e=>{"boolean"==typeof e&&p(e)}}),(0,t.jsx)(K.Label_Shadcn_,{htmlFor:"is-primary-billing-address",className:"text-foreground-light",children:"Use the billing address as my organization's primary address"})]})]}),(0,t.jsx)(j.Modal.Separator,{}),(0,t.jsxs)(j.Modal.Content,{className:"flex items-center space-x-2",children:[(0,t.jsx)(q.Button,{htmlType:"button",size:"small",type:"default",onClick:e,block:!0,disabled:l,children:"Cancel"}),(0,t.jsx)(q.Button,{block:!0,htmlType:"button",size:"small",type:"primary",loading:l,disabled:l,onClick:S,children:"Add payment method"})]})]})};var G=e.i(340657);let V=(0,y.loadStripe)(N.STRIPE_PUBLIC_KEY),W=({visible:e,returnUrl:a,onCancel:i,onConfirm:r})=>{let{resolvedTheme:n}=(0,f.useTheme)(),[l,d]=(0,s.useState)(),{data:c}=(0,o.useSelectedOrganizationQuery)(),[u,m]=(0,s.useState)(null),[p,y]=(0,s.useState)(null),{mutate:b}=S({onSuccess:e=>{d(e)},onError:e=>{h.toast.error(`Failed to setup intent: ${e.message}`)}}),_=(0,s.useCallback)(e=>{y(e)},[]);(0,s.useEffect)(()=>{let a=async e=>{let a=c?.slug;return a?e?void(d(void 0),b({slug:a,hcaptchaToken:e})):console.error("HCaptcha token required"):console.error("Slug is required")};(async()=>{if(e&&p){let e=u;try{if(!e){let a=await p.execute({async:!0});e=a?.response??null}}catch(e){return}await a(e??void 0),v()}})()},[e,p]);let v=()=>{m(null),p?.resetCaptcha()},N={clientSecret:l?l.client_secret:"",appearance:(0,G.getStripeElementsAppearanceOptions)(n)},C=()=>(d(void 0),i());return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(g.default,{ref:_,sitekey:"4ca1fdb9-c9c9-4495-ba50-c85fc0e7ec1f",size:"invisible",onOpen:()=>{void 0!==document&&document.body.classList.add("!pointer-events-auto")},onClose:()=>{C(),void 0!==document&&document.body.classList.remove("!pointer-events-auto")},onVerify:e=>{m(e),void 0!==document&&document.body.classList.remove("!pointer-events-auto")},onExpire:()=>{m(null)}}),(0,t.jsx)(j.Modal,{hideFooter:!0,size:"medium",visible:e&&void 0!==l,header:"Add new payment method",onCancel:C,className:"PAYMENT",children:(0,t.jsx)(x.Elements,{stripe:V,options:N,children:(0,t.jsx)(Y,{returnUrl:a,onCancel:C,onConfirm:()=>(d(void 0),r())})})})]})};var H=e.i(196621),X=e.i(567558),J=e.i(344629),Z=e.i(64102),ee=e.i(693241),ea=e.i(932662);async function et({slug:e},a){if(!e)throw Error("slug is required");let{data:t,error:s}=await (0,_.get)("/platform/organizations/{slug}/payments",{params:{path:{slug:e}},headers:{Version:"2"},signal:a});return s&&(0,_.handleError)(s),t}let es=({slug:e},{enabled:a=!0,...t}={})=>{let{can:s}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.BILLING_READ,"stripe.payment_methods");return(0,T.useQuery)({queryKey:P.organizationKeys.paymentMethods(e),queryFn:({signal:a})=>et({slug:e},a),enabled:a&&void 0!==e&&s,...t})};var ei=e.i(837508),er=e.i(48189),en=e.i(710483);let el=({selectedPaymentMethod:e,onClose:a})=>{let{slug:s}=(0,i.useParams)(),{mutate:r,isPending:n}=D({onSuccess:()=>{h.toast.success(`Successfully changed payment method to the card ending with ${e.card.last4}`),a()},onError:e=>{h.toast.error(`Failed to change payment method: ${e.message}`)}}),l=async()=>s?e?void r({slug:s,paymentMethodId:e.id}):console.error("Card ID is required"):console.error("Slug is required");return(0,t.jsx)(j.Modal,{visible:void 0!==e,size:"medium",header:`Confirm to use payment method ending with ${e?.card?.last4}`,onCancel:()=>a(),customFooter:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(q.Button,{type:"default",disabled:n,onClick:()=>a(),children:"Cancel"}),(0,t.jsx)(q.Button,{type:"primary",disabled:n,loading:n,onClick:l,children:"Confirm"})]}),children:(0,t.jsx)(j.Modal.Content,{children:(0,t.jsxs)("p",{className:"text-sm",children:["Upon clicking confirm, all future charges will be deducted from the card ending with"," ",e?.card?.last4,". There are no immediate charges."]})})})};var eo=e.i(275887),ed=e.i(423782),ec=e.i(587433),eu=e.i(874311);let em=({paymentMethod:e,canUpdatePaymentMethods:a=!0,paymentMethodType:s,subscriptionPlan:i,paymentMethodCount:r,setSelectedMethodForUse:n,setSelectedMethodToDelete:l})=>{let o=e.is_default,d=!e.is_default||"free"===i&&1===r,c=e.card?.exp_year??0,u=e.card?.exp_month??0,m=new Date().getMonth()+1,p=new Date().getFullYear();return e.card?(0,t.jsxs)("div",{className:"flex items-center justify-between gap-8",children:[(0,t.jsxs)("div",{className:"flex items-center gap-8",children:[(0,t.jsx)("img",{alt:"Credit card brand",src:`${N.BASE_PATH}/img/payment-methods/${e.card.brand.replace(" ","-").toLowerCase()}.png`,width:"32"}),(0,t.jsxs)("p",{className:"prose text-sm font-mono",children:["**** **** **** ",e.card.last4]}),(0,t.jsxs)("p",{className:"text-sm tabular-nums",children:["Expires: ",e.card.exp_month,"/",e.card.exp_year]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[c===p&&u===m&&(0,t.jsx)(ec.Badge,{variant:"warning",children:"Expiring soon"}),(c<p||c===p&&u<m)&&(0,t.jsx)(ec.Badge,{variant:"destructive",children:"Expired"}),o&&(0,t.jsx)(ec.Badge,{variant:"success",children:"Active"}),a&&(0,t.jsxs)(eu.DropdownMenu,{children:[(0,t.jsx)(eu.DropdownMenuTrigger,{asChild:!0,children:(0,t.jsx)(q.Button,{type:"outline",className:"hover:border-muted px-1",icon:(0,t.jsx)(eo.MoreHorizontal,{}),"aria-label":"More options"})}),(0,t.jsxs)(eu.DropdownMenuContent,{align:"end",className:"w-36",children:["card"===s&&!o&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(eu.DropdownMenuItem,{onClick:()=>n?.(e),children:(0,t.jsx)("p",{children:"Use this card"})},"make-default"),(0,t.jsx)(eu.DropdownMenuSeparator,{})]}),(0,t.jsx)(ed.DropdownMenuItemTooltip,{disabled:!d,className:"!pointer-events-auto",onClick:()=>l?.(e),tooltip:{content:{side:"left",text:d?void 0:"Unable to delete a card that is currently active"}},children:(0,t.jsx)("p",{children:"Delete card"})},"delete-method")]})]})]})]},e.id):null};async function ep({slug:e,cardId:a}){let{data:t,error:s}=await (0,_.del)("/platform/organizations/{slug}/payments",{body:{card_id:a},params:{path:{slug:e}}});return s&&(0,_.handleError)(s),t}let eh=({selectedPaymentMethod:e,onClose:a})=>{let{slug:s}=(0,i.useParams)(),{mutate:r,isPending:n}=(({onSuccess:e,onError:a,...t}={})=>{let s=(0,C.useQueryClient)();return(0,b.useMutation)({mutationFn:e=>ep(e),async onSuccess(a,t,i){let{slug:r}=t;await s.invalidateQueries({queryKey:P.organizationKeys.paymentMethods(r)}),await e?.(a,t,i)},async onError(e,t,s){void 0===a?h.toast.error(`Failed to delete payment method: ${e.message}`):a(e,t,s)},...t})})({onSuccess:()=>{h.toast.success(`Successfully removed payment method ending with ${e?.card?.last4}`),a()}}),l=async()=>s?e?void r({slug:s,cardId:e.id}):console.error("Card ID is required"):console.error("Slug is required");return(0,t.jsx)(j.Modal,{visible:void 0!==e,size:"medium",header:`Confirm to delete payment method ending with ${e?.card?.last4}`,onCancel:()=>a(),customFooter:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(q.Button,{type:"default",disabled:n,onClick:()=>a(),children:"Cancel"}),(0,t.jsx)(q.Button,{type:"primary",disabled:n,loading:n,onClick:l,children:"Confirm"})]}),children:(0,t.jsx)(j.Modal.Content,{children:(0,t.jsx)(en.Admonition,{type:"default",title:"This will permanently delete your payment method.",description:"You can re-add the payment method any time."})})})},eg=()=>{let{slug:e}=(0,i.useParams)(),{data:a}=(0,o.useSelectedOrganizationQuery)(),[l,d]=(0,s.useState)(),[u,g]=(0,s.useState)(),[x,y]=(0,s.useState)(!1),{data:f}=(0,n.useOrgSubscriptionQuery)({orgSlug:e}),{data:j,error:b,isPending:_,isError:v,isSuccess:S}=es({slug:e}),{can:N,isSuccess:C}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.BILLING_READ,"stripe.payment_methods"),{can:w}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.BILLING_WRITE,"stripe.payment_methods");return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(r.ScaffoldSection,{children:[(0,t.jsx)(r.ScaffoldSectionDetail,{children:(0,t.jsxs)("div",{className:"sticky space-y-2 top-12",children:[(0,t.jsx)("p",{className:"text-foreground text-base m-0",children:"Payment Methods"}),(0,t.jsx)("p",{className:"text-sm text-foreground-light mb-2 pr-4 m-0",children:"Payments for your subscription are made using the default card."})]})}),(0,t.jsx)(r.ScaffoldSectionContent,{children:a?.managed_by!==void 0&&a?.managed_by!==ei.MANAGED_BY.SUPABASE?(0,t.jsx)(ea.default,{managedBy:a?.managed_by,resource:"Payment Methods",cta:{installationId:a?.partner_id}}):C&&!N?(0,t.jsx)(ee.default,{resourceText:"view this organization's payment methods"}):(0,t.jsxs)(t.Fragment,{children:[_&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(Q.ShimmeringLoader,{}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-3/4"}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-1/2"})]}),v&&(0,t.jsx)(X.default,{subject:"Failed to retrieve payment methods",error:b}),S&&(0,t.jsxs)(t.Fragment,{children:[f?.payment_method_type==="invoice"&&(0,t.jsx)(en.Admonition,{type:"note",layout:"horizontal",title:"Payment is currently by invoice",description:"You get a monthly invoice and payment link via email. To change your payment method, please contact us via our support form.",actions:(0,t.jsx)(q.Button,{asChild:!0,type:"default",children:(0,t.jsx)(H.SupportLink,{queryParams:{category:c.SupportCategories.BILLING,subject:"Request to change payment method"},children:"Contact support"})},"payment-method-support")}),(0,t.jsx)(J.FormPanel,{footer:(0,t.jsxs)("div",{className:"flex items-center justify-between py-4 px-8",children:[w?(0,t.jsx)("div",{}):(0,t.jsx)("p",{className:"text-sm text-foreground-light",children:"You need additional permissions to manage payment methods"}),(0,t.jsx)(q.Button,{type:"default",icon:(0,t.jsx)(p.Plus,{}),disabled:!w,onClick:()=>y(!0),children:"Add new card"})]}),children:(0,t.jsx)(Z.FormSection,{children:(0,t.jsx)(Z.FormSectionContent,{fullWidth:!0,loading:!1,children:(j?.data?.length??0)===0?(0,t.jsxs)("div",{className:"flex items-center gap-2 opacity-50",children:[(0,t.jsx)(m,{size:16,strokeWidth:1.5}),(0,t.jsx)("p",{className:"text-sm",children:"No payment methods"})]}):(0,t.jsx)("div",{className:"space-y-3",children:j?.data?.map(e=>(0,t.jsx)(em,{paymentMethod:e,canUpdatePaymentMethods:w,paymentMethodType:f?.payment_method_type,setSelectedMethodForUse:d,setSelectedMethodToDelete:g,paymentMethodCount:j?.data.length??0,subscriptionPlan:f?.plan.id},e.id))})})})})]})]})})]}),(0,t.jsx)(W,{visible:x,returnUrl:`${(0,er.getURL)()}/org/${e}/billing`,onCancel:()=>y(!1),onConfirm:()=>{y(!1),h.toast.success("Successfully added new payment method")}}),(0,t.jsx)(el,{selectedPaymentMethod:l,onClose:()=>d(void 0)}),(0,t.jsx)(eh,{selectedPaymentMethod:u,onClose:()=>g(void 0)})]})};var ex=e.i(937942),ey=e.i(613580),ef=((a={}).PAID="paid",a.VOID="void",a.UNCOLLECTIBLE="uncollectible",a.OPEN="open",a.ISSUED="issued",a);let ej={[ef.PAID]:{label:"Paid",badgeVariant:"success"},[ef.VOID]:{label:"Forgiven",badgeVariant:"warning"},[ef.UNCOLLECTIBLE]:{label:"Outstanding",badgeVariant:"destructive"},[ef.OPEN]:{label:"Outstanding",badgeVariant:"destructive"},[ef.ISSUED]:{label:"Outstanding",badgeVariant:"destructive"}},eb=({status:e,paymentAttempted:a,paymentProcessing:s})=>{let i=s?{label:"Processing",badgeVariant:"warning"}:ej[e];return(0,t.jsxs)(ey.Tooltip,{children:[(0,t.jsx)(ey.TooltipTrigger,{children:(0,t.jsx)(ec.Badge,{variant:i?.badgeVariant||"default",children:i?.label||e})}),(0,t.jsxs)(ey.TooltipContent,{side:"bottom",className:"max-w-xs [&>p]:text-center [&>div>p]:text-center",children:[[ef.OPEN,ef.ISSUED,ef.UNCOLLECTIBLE].includes(e)&&(s?(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("p",{children:"While most credit card payments get processed instantly, some Indian card providers may take up to 72 hours to process payments. We’re still waiting for your card provider to process this payment."}),(0,t.jsxs)("p",{children:["We recommend proactively"," ",(0,t.jsx)(ex.InlineLink,{href:`${N.DOCS_URL}/guides/platform/credits#credit-top-ups`,children:"topping up your credits"})," ","to avoid this issue in the future."]})]}):a?(0,t.jsx)("p",{children:"We were not able to collect the payment. Make sure you have a valid payment method and enough funds. Outstanding invoices may cause restrictions. You can manually pay the invoice using the “Pay now” button."}):(0,t.jsx)("p",{children:"The invoice will soon be charged for. Please make sure to pay in a timely manner, especially if you pay via invoice instead of card. You can pay the invoice using your card using the “Pay now” button."})),e===ef.PAID&&(0,t.jsx)("p",{children:"The invoice has been paid successfully. No further action is required on your side."}),e===ef.VOID&&(0,t.jsx)("p",{children:"This invoice has been forgiven. No further action is required on your side."})]})]})};var e_=e.i(215312),ev=e.i(195998);async function eS({invoiceId:e,slug:a},t){if(!e)throw Error("Invoice ID is required");if(!a)throw Error("Slug is required");let{data:s,error:i}=await (0,_.get)("/platform/organizations/{slug}/billing/invoices/{invoice_id}",{params:{path:{invoice_id:e,slug:a}},signal:t});return i&&(0,_.handleError)(i),s}async function eN({invoiceId:e,slug:a},t){if(!e)throw Error("Invoice ID is required");if(!a)throw Error("Slug is required");let{data:s,error:i}=await (0,_.get)("/platform/organizations/{slug}/billing/invoices/{invoice_id}/receipt",{params:{path:{invoice_id:e,slug:a}},signal:t});return i&&(0,_.handleError)(i),s}async function eC({slug:e},a){if(!e)throw Error("Slug is required");let t=await (0,_.head)("/platform/organizations/{slug}/billing/invoices",{params:{path:{slug:e}},signal:a,parseAs:"text"});if(t.error)throw t.error;return Number(t.response.headers.get("X-Total-Count"))}async function ew({slug:e,offset:a=0,limit:t=10},s){if(!e)throw Error("Org slug is required");let{data:i,error:r}=await (0,_.get)("/platform/organizations/{slug}/billing/invoices",{params:{path:{slug:e},query:{offset:a,limit:t}},signal:s});return r&&(0,_.handleError)(r),i}var eP=e.i(55956),eT=e.i(954676),eA=e.i(416050),eE=e.i(291969),eI=e.i(667884),ek=e.i(960432),eM=e.i(627069),eL=e.i(492418);async function eF({slug:e,invoiceId:a}){if(!e)throw Error("Org slug is required");if(!a)throw Error("Invoice ID is required");let{data:t,error:s}=await (0,_.get)("/platform/organizations/{slug}/billing/invoices/{invoice_id}/payment-link",{params:{path:{slug:e,invoice_id:a}}});return s&&(0,_.handleError)(s),t}let eD=({slug:e,invoiceId:a})=>{let{mutate:s,isPending:i}=(({onError:e,...a}={})=>{let t=(0,C.useQueryClient)();return(0,b.useMutation)({mutationFn:e=>eF(e),async onError(a,s,i){await Promise.all([t.invalidateQueries({queryKey:ev.invoicesKeys.listAndCount(s.slug)})]),void 0===e?h.toast.error(a.message):e(a,s,i)},...a})})({onSuccess(e){h.toast.success("Redirecting to payment gateway..."),window.location.href=e.redirectUrl}});return(0,t.jsx)(q.Button,{onClick:function(){s({slug:e,invoiceId:a})},loading:i,disabled:i,children:"Pay now"})},ez=()=>{let[e,a]=(0,s.useState)(1),{data:i}=(0,o.useSelectedOrganizationQuery)(),r=i?.slug,n=(e-1)*5,{data:l,isError:c}=(({slug:e},{enabled:a=!0,...t}={})=>(0,T.useQuery)({queryKey:ev.invoicesKeys.count(e),queryFn:({signal:a})=>eC({slug:e},a),enabled:a&&void 0!==e,...t}))({slug:r},{enabled:i?.managed_by==="supabase"}),{data:u,error:m,isPending:p,isError:g}=(({slug:e,offset:a,limit:t},{enabled:s=!0,...i}={})=>(0,T.useQuery)({queryKey:ev.invoicesKeys.list(e,a),queryFn:({signal:s})=>ew({slug:e,offset:a,limit:t},s),enabled:s&&void 0!==e,...i}))({slug:r,offset:n,limit:5},{enabled:i?.managed_by==="supabase"}),x=u||[];(0,s.useEffect)(()=>{a(1)},[r]);let y=async e=>{try{let a=await eS({invoiceId:e,slug:r});a?.invoice_pdf&&window.open(a.invoice_pdf,"_blank")}catch(e){h.toast.error(`Failed to fetch the selected invoice: ${e.message}`)}},f=async e=>{if(r)try{let a=await eN({invoiceId:e,slug:r});a?.receipt_pdf&&window.open(a.receipt_pdf,"_blank")}catch(e){h.toast.error(`Failed to fetch receipt: ${e.message}`)}};if(i?.managed_by!==void 0&&i?.managed_by!=="supabase")return(0,t.jsx)(ea.default,{managedBy:i?.managed_by,resource:"Invoices",cta:i.managed_by===ei.MANAGED_BY.VERCEL_MARKETPLACE?{installationId:i?.partner_id,path:"/invoices"}:i.managed_by===ei.MANAGED_BY.AWS_MARKETPLACE?{organizationSlug:i?.slug,overrideUrl:"https://console.aws.amazon.com/billing/home#/bills"}:void 0});let j=p||0===x.length?"text-foreground-muted":void 0;return(0,t.jsxs)(eM.Card,{children:[(0,t.jsxs)(eL.Table,{children:[(0,t.jsx)(eL.TableHeader,{children:(0,t.jsxs)(eL.TableRow,{children:[x.length>0&&(0,t.jsx)(eL.TableHead,{className:"w-2",children:(0,t.jsx)("span",{className:"sr-only",children:"Icon"})}),(0,t.jsx)(eL.TableHead,{className:(0,d.cn)(j),children:"Date"}),(0,t.jsx)(eL.TableHead,{className:(0,d.cn)(j),children:"Amount"}),(0,t.jsx)(eL.TableHead,{className:(0,d.cn)(j),children:"Invoice number"}),(0,t.jsx)(eL.TableHead,{className:(0,d.cn)(j),children:"Status"}),(0,t.jsx)(eL.TableHead,{children:(0,t.jsx)("span",{className:"sr-only",children:"Actions"})})]})}),(0,t.jsx)(eL.TableBody,{children:p?Array(6).fill(0).map((e,a)=>(0,t.jsx)(eL.TableRow,{children:(0,t.jsx)(eL.TableCell,{colSpan:x.length>0?6:5,children:(0,t.jsx)(Q.ShimmeringLoader,{})})},`loading-${a}`)):g?(0,t.jsx)(eL.TableRow,{className:"rounded-b",children:(0,t.jsx)(eL.TableCell,{colSpan:x.length>0?6:5,className:"!p-0 !rounded-b overflow-hidden",children:(0,t.jsx)(X.default,{className:"border-0 rounded-none",error:m,subject:"Failed to retrieve invoices"})})}):0===x.length?(0,t.jsx)(eL.TableRow,{className:"[&>td]:hover:bg-inherit",children:(0,t.jsx)(eL.TableCell,{colSpan:5,className:"py-6",children:(0,t.jsx)("p",{className:"text-foreground-lighter",children:"No invoices for this organization yet"})})}):(0,t.jsx)(t.Fragment,{children:x.map(e=>(0,t.jsxs)(eL.TableRow,{children:[(0,t.jsx)(eL.TableCell,{className:"w-2",children:(0,t.jsx)(eE.FileText,{"aria-hidden":"true",size:16,className:"text-foreground-muted"})}),(0,t.jsx)(eL.TableCell,{children:(0,t.jsx)("p",{children:(0,eP.default)(1e3*e.period_end).format("MMM DD, YYYY")})}),(0,t.jsx)(eL.TableCell,{translate:"no",children:(0,t.jsx)("p",{children:(0,er.formatCurrency)(e.amount_due/100)})}),(0,t.jsx)(eL.TableCell,{children:(0,t.jsx)("p",{className:"font-mono text-foreground-light",children:e.number})}),(0,t.jsx)(eL.TableCell,{children:(0,t.jsx)(eb,{status:e.status,paymentAttempted:e.payment_attempted,paymentProcessing:e.payment_is_processing})}),(0,t.jsx)(eL.TableCell,{className:"text-right",children:(0,t.jsxs)("div",{className:"flex items-center justify-end space-x-2",children:[e.amount_due>0&&!e.payment_is_processing&&[ef.UNCOLLECTIBLE,ef.OPEN,ef.ISSUED].includes(e.status)&&(0,t.jsx)(eD,{slug:r,invoiceId:e.id}),(0,t.jsx)(e_.ButtonTooltip,{type:"outline",className:"w-7",icon:(0,t.jsx)(ek.ScrollText,{size:16,strokeWidth:1.5}),onClick:()=>y(e.id),tooltip:{content:{side:"bottom",text:"Download invoice"}}}),e.status===ef.PAID&&e.amount_due>0&&(0,t.jsx)(e_.ButtonTooltip,{type:"outline",className:"w-7",icon:(0,t.jsx)(eI.Receipt,{size:16,strokeWidth:1.5}),onClick:()=>f(e.id),tooltip:{content:{side:"bottom",text:"Download receipt"}}})]})})]},e.id))})})]}),x.length>0&&(0,t.jsxs)(eM.CardFooter,{className:"border-t p-4 flex items-center justify-between",children:[(0,t.jsx)("p",{className:"text-foreground-muted text-sm",children:c?"Failed to retrieve total number of invoices":"number"==typeof l?`Showing ${n+1} to ${n+x.length} out of ${l} invoices`:`Showing ${n+1} to ${n+x.length} invoices`}),(0,t.jsxs)("div",{className:"flex items-center gap-x-2","aria-label":"Pagination",children:[(0,t.jsx)(q.Button,{icon:(0,t.jsx)(eT.ChevronLeft,{}),"aria-label":"Previous page",type:"default",size:"tiny",disabled:1===e,onClick:async()=>a(e-1)}),(0,t.jsx)(q.Button,{icon:(0,t.jsx)(eA.ChevronRight,{}),"aria-label":"Next page",type:"default",size:"tiny",disabled:5*e>=(l??0),onClick:async()=>a(e+1)})]})]})]})},eR=()=>{let{isSuccess:e,can:a}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.BILLING_READ,"stripe.subscriptions");return(0,t.jsxs)(r.ScaffoldSection,{children:[(0,t.jsx)(r.ScaffoldSectionDetail,{children:(0,t.jsxs)("div",{className:"sticky space-y-2 top-12 pr-6",children:[(0,t.jsx)("p",{className:"text-foreground text-base m-0",children:"Past Invoices"}),(0,t.jsx)("p",{className:"prose text-sm",children:"You get an invoice every time you change your plan or when your monthly billing cycle resets."})]})}),(0,t.jsx)(r.ScaffoldSectionContent,{children:e&&!a?(0,t.jsx)(ee.default,{resourceText:"view this organization's upcoming invoice"}):(0,t.jsx)(ez,{})})]})};var eO=e.i(210419),eU=e.i(101369),eB=e.i(129393);async function eq({orgSlug:e},a){if(!e)throw Error("orgSlug is required");let{data:t,error:s}=await (0,_.get)("/platform/organizations/{slug}/billing/invoices/upcoming",{params:{path:{slug:e}},headers:{Version:"2"},signal:a});return s&&(0,_.handleError)(s),t}var e$=e.i(252387),eK=e.i(367051);let eQ={[eB.PricingMetric.MONTHLY_ACTIVE_USERS]:`${N.DOCS_URL}/guides/platform/manage-your-usage/monthly-active-users`,[eB.PricingMetric.MONTHLY_ACTIVE_SSO_USERS]:`${N.DOCS_URL}/guides/platform/manage-your-usage/monthly-active-users-sso`,[eB.PricingMetric.MONTHLY_ACTIVE_THIRD_PARTY_USERS]:`${N.DOCS_URL}/guides/platform/manage-your-usage/monthly-active-users-third-party`,[eB.PricingMetric.AUTH_MFA_PHONE]:`${N.DOCS_URL}/guides/platform/manage-your-usage/advanced-mfa-phone`,[eB.PricingMetric.EGRESS]:`${N.DOCS_URL}/guides/platform/manage-your-usage/egress`,[eB.PricingMetric.CACHED_EGRESS]:`${N.DOCS_URL}/guides/platform/manage-your-usage/egress`,[eB.PricingMetric.FUNCTION_INVOCATIONS]:`${N.DOCS_URL}/guides/platform/manage-your-usage/edge-function-invocations`,[eB.PricingMetric.STORAGE_SIZE]:`${N.DOCS_URL}/guides/platform/manage-your-usage/storage-size`,[eB.PricingMetric.STORAGE_IMAGES_TRANSFORMED]:`${N.DOCS_URL}/guides/platform/manage-your-usage/storage-image-transformations`,[eB.PricingMetric.REALTIME_MESSAGE_COUNT]:`${N.DOCS_URL}/guides/platform/manage-your-usage/realtime-messages`,[eB.PricingMetric.REALTIME_PEAK_CONNECTIONS]:`${N.DOCS_URL}/guides/platform/manage-your-usage/realtime-peak-connections`,[eB.PricingMetric.CUSTOM_DOMAIN]:`${N.DOCS_URL}/guides/platform/manage-your-usage/custom-domains`,[eB.PricingMetric.IPV4]:`${N.DOCS_URL}/guides/platform/manage-your-usage/ipv4`,[eB.PricingMetric.PITR_7]:`${N.DOCS_URL}/guides/platform/manage-your-usage/point-in-time-recovery`,[eB.PricingMetric.PITR_14]:`${N.DOCS_URL}/guides/platform/manage-your-usage/point-in-time-recovery`,[eB.PricingMetric.PITR_28]:`${N.DOCS_URL}/guides/platform/manage-your-usage/point-in-time-recovery`,[eB.PricingMetric.DISK_SIZE_GB_HOURS_GP3]:`${N.DOCS_URL}/guides/platform/manage-your-usage/disk-size`,[eB.PricingMetric.DISK_SIZE_GB_HOURS_IO2]:`${N.DOCS_URL}/guides/platform/manage-your-usage/disk-size`,[eB.PricingMetric.DISK_IOPS_GP3]:`${N.DOCS_URL}/guides/platform/manage-your-usage/disk-iops`,[eB.PricingMetric.DISK_IOPS_IO2]:`${N.DOCS_URL}/guides/platform/manage-your-usage/disk-iops`,[eB.PricingMetric.DISK_THROUGHPUT_GP3]:`${N.DOCS_URL}/guides/platform/manage-your-usage/disk-throughput`,[eB.PricingMetric.LOG_DRAIN]:`${N.DOCS_URL}/guides/platform/manage-your-usage/log-drains`};function eY({amountBeforeDiscount:e,amount:a}){return e&&a<e?(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"text-foreground-light line-through mr-2",translate:"no",children:(0,er.formatCurrency)(e)}),(0,t.jsx)("span",{translate:"no",children:(0,er.formatCurrency)(a)})]}):(0,t.jsx)("span",{translate:"no",children:(0,er.formatCurrency)(a)})}function eG({computeItems:e,tooltip:a,title:s,computeCredits:i}){let r=e.flatMap(e=>e.breakdown.map(a=>({...a,computeType:e.description,computeCosts:a.amount}))).sort((e,a)=>a.computeCosts-e.computeCosts),n=e.sort((e,a)=>a.amount-e.amount),l=Math.max(0,e.reduce((e,a)=>e+a.amount_before_discount,0)),o=Math.max(0,e.reduce((e,a)=>e+(a.amount??0),0)+(i?.amount??0));return e.length?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(eL.TableRow,{children:[(0,t.jsxs)(eL.TableCell,{className:"!py-2 px-0 flex items-center gap-1",children:[(0,t.jsx)("span",{children:s}),(0,t.jsx)(e$.InfoTooltip,{className:"max-w-sm",children:a})]}),(0,t.jsx)(eL.TableCell,{className:"text-right py-2 px-0",children:(0,t.jsx)(eY,{amount:o,amountBeforeDiscount:l})})]}),r.map(e=>(0,t.jsxs)(eL.TableRow,{className:"text-foreground-light text-xs",children:[(0,t.jsxs)(eL.TableCell,{className:"!py-2 px-0 pl-6",children:[e.project_name," (",e.computeType," - ",e.usage," Hours)"]}),(0,t.jsx)(eL.TableCell,{className:"!py-2 px-0 text-right",translate:"no",children:(0,er.formatCurrency)(e.computeCosts)})]},e.project_ref)),!r.length&&n.map(e=>(0,t.jsxs)(eL.TableRow,{className:"text-foreground-light text-xs",children:[(0,t.jsxs)(eL.TableCell,{className:"!py-2 px-0 pl-6",children:[e.description," - ",e.usage_original," Hours"]}),(0,t.jsx)(eL.TableCell,{className:"!py-2 px-0 text-right",translate:"no",children:(0,er.formatCurrency)(e.amount)})]},s+e.usage_metric)),i&&(0,t.jsxs)(eL.TableRow,{className:"text-foreground-light text-xs",children:[(0,t.jsx)(eL.TableCell,{className:"!py-2 px-0 pl-6",children:"Compute Credits"}),(0,t.jsx)(eL.TableCell,{className:"!py-2 px-0 text-right",translate:"no",children:(0,er.formatCurrency)(i.amount)})]})]}):null}let eV=({slug:e})=>{let{data:a,error:s,isPending:i,isError:r,isSuccess:n}=(({orgSlug:e},{enabled:a=!0,...t}={})=>(0,T.useQuery)({queryKey:ev.invoicesKeys.orgUpcomingPreview(e),queryFn:({signal:a})=>eq({orgSlug:e},a),enabled:a&&void 0!==e,...t}))({orgSlug:e}),l=a?.lines?.filter(e=>e.description?.toLowerCase().includes("compute"))||[],o=a?.lines?.find(e=>e.description.startsWith("Compute Credits"))??null,d=a?.lines?.find(e=>e.description?.toLowerCase().includes("plan")),c=l.filter(e=>!e.metadata?.is_branch&&!e.metadata?.is_read_replica),u=l.filter(e=>e.metadata?.is_branch),m=l.filter(e=>e.metadata?.is_read_replica),p=a?.lines?.filter(e=>!e.description?.toLowerCase().includes("compute")&&!e.description?.toLowerCase().includes("plan")&&e.amount_before_discount>0).sort((e,a)=>a.amount_before_discount-e.amount_before_discount)||[];return(0,t.jsxs)(t.Fragment,{children:[i&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(Q.ShimmeringLoader,{}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-3/4"}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-1/2"})]}),r&&(0,t.jsx)(X.default,{subject:"Failed to retrieve upcoming invoice",error:s}),n&&(0,t.jsx)("div",{children:(0,t.jsx)("div",{children:(0,t.jsxs)(eL.Table,{className:"w-full text-sm",children:[(0,t.jsxs)(eL.TableBody,{children:[(0,t.jsxs)(eL.TableRow,{children:[(0,t.jsx)(eL.TableCell,{className:"!py-2 px-0",children:d?.description}),(0,t.jsx)(eL.TableCell,{className:"text-right py-2 px-0",children:null==d?"-":(0,t.jsx)(eY,{amount:d.amount,amountBeforeDiscount:d.amount_before_discount})})]}),(0,t.jsx)(eG,{computeItems:c,title:"Compute",computeCredits:o,tooltip:(0,t.jsxs)("p",{className:"prose text-xs",children:["The first project is covered by Compute Credits. Additional projects incur compute costs starting at ",(0,t.jsx)("span",{translate:"no",children:"$10"}),"/month, independent of activity. See"," ",(0,t.jsx)(eO.default,{href:`${N.DOCS_URL}/guides/platform/manage-your-usage/compute`,target:"_blank",children:"docs"}),"."]})}),(0,t.jsx)(eG,{title:"Replica Compute",computeItems:m,tooltip:(0,t.jsxs)("p",{className:"prose text-xs",children:["Each Read Replica is a dedicated database. You are charged for its resources: Compute, Disk Size, provisioned Disk IOPS, provisioned Disk Throughput, and IPv4. See"," ",(0,t.jsx)(eO.default,{href:`${N.DOCS_URL}/guides/platform/manage-your-usage/read-replicas`,target:"_blank",children:"docs"}),"."]})}),u.length>0&&(0,t.jsxs)(eL.TableRow,{children:[(0,t.jsx)(eL.TableCell,{className:"py-2 px-0",children:(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)("span",{children:"Branching"}),(0,t.jsxs)(e$.InfoTooltip,{className:"max-w-sm",children:[(0,t.jsx)("ul",{className:"ml-6 list-disc",children:u.flatMap(e=>e.breakdown).map(e=>(0,t.jsxs)("li",{children:[e.project_name," (",e.usage," Hours)"]},`branching-breakdown-${e.project_ref}`))}),(0,t.jsxs)("p",{className:"mt-2",children:["See"," ",(0,t.jsx)(eO.default,{className:"underline",href:`${N.DOCS_URL}/guides/platform/manage-your-usage/branching`,target:"_blank",children:"docs"})," ","on how billing for Branching works."]})]})]})}),(0,t.jsx)(eL.TableCell,{className:"text-right py-2 px-0",children:(0,t.jsx)(eY,{amount:u.reduce((e,a)=>e+a.amount,0),amountBeforeDiscount:u.reduce((e,a)=>e+(a.amount_before_discount??0),0)})})]}),p.map(a=>(0,t.jsxs)(eL.TableRow,{children:[(0,t.jsx)(eL.TableCell,{className:"py-2 px-0",children:(0,t.jsxs)("div",{className:"gap-1 flex items-center",children:[(0,t.jsx)("span",{children:a.description??"Unknown"}),(a.breakdown&&a.breakdown.length>0||null!=a.usage_metric)&&(0,t.jsxs)(e$.InfoTooltip,{className:"max-w-sm",children:[a.unit_price_desc&&(0,t.jsxs)("p",{className:"mb-2",translate:"no",children:["Pricing: ",a.unit_price_desc]}),a.breakdown&&a.breakdown.length>0&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("p",{children:["Projects using ",a.description,":"]}),(0,t.jsx)("ul",{className:"ml-6 list-disc",children:a.breakdown.map(e=>(0,t.jsxs)("li",{children:[(0,t.jsx)(eO.default,{className:"underline",href:`/project/${e.project_ref}`,target:"_blank",children:e.project_name})," ",a.usage_metric&&(0,t.jsxs)("span",{children:["(",(0,eK.formatUsage)(a.usage_metric,e)," ",(0,eK.billingMetricUnit)(a.usage_metric),")"]})]},`${a.description}-breakdown-${e.project_ref}`))})]}),a.usage_metric&&null!=eQ[a.usage_metric]&&(0,t.jsxs)("p",{className:"mt-2",children:["See"," ",(0,t.jsx)(eO.default,{className:"underline",href:eQ[a.usage_metric],target:"_blank",children:"docs"})," ","on how billing for ",a.description," works and"," ",(0,t.jsx)(eO.default,{className:"underline",href:`/organization/${e}/usage`,children:"usage page"})," ","for a detailed breakdown."]})]})]})}),(0,t.jsx)(eL.TableCell,{className:"text-right py-2 px-0",children:(0,t.jsx)(eY,{amount:a.amount,amountBeforeDiscount:a.amount_before_discount})})]},a.description))]}),(0,t.jsxs)(eL.TableFooter,{children:[(0,t.jsxs)(eL.TableRow,{children:[(0,t.jsxs)(eL.TableCell,{className:"font-medium py-2 px-0 flex items-center",children:[(0,t.jsx)("span",{className:"mr-2",children:"Current Costs"}),(0,t.jsx)(e$.InfoTooltip,{children:"Costs accumulated from the beginning of the billing cycle up to now."})]}),(0,t.jsx)(eL.TableCell,{className:"text-right font-medium py-2 px-0",translate:"no",children:(0,er.formatCurrency)(a?.amount_total)??"-"})]}),a?.amount_projected&&(0,t.jsxs)(eL.TableRow,{children:[(0,t.jsxs)(eL.TableCell,{className:"font-medium py-2 px-0 flex items-center",children:[(0,t.jsx)("span",{className:"mr-2",children:"Projected Costs"}),(0,t.jsx)(e$.InfoTooltip,{className:"max-w-xs",children:"Projected costs at the end of the billing cycle. Includes predictable costs for Compute Hours, IPv4, Custom Domain and Point-In-Time-Recovery, but no costs for metrics like MAU, storage or function invocations. Final amounts may vary depending on your usage."})]}),(0,t.jsx)(eL.TableCell,{className:"text-right font-medium py-2 px-0",translate:"no",children:(0,er.formatCurrency)(a.amount_projected)??"-"})]})]})]})})})]})},eW=()=>{let{slug:e}=(0,i.useParams)(),{data:a}=(0,o.useSelectedOrganizationQuery)(),{isSuccess:s,can:d}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.BILLING_READ,"stripe.subscriptions"),{data:u,error:m,isPending:p,isError:h}=(0,n.useOrgSubscriptionQuery)({orgSlug:e},{enabled:d}),g=(0,l.useIsFeatureEnabled)("billing:invoices"),x=eP.default.unix(u?.current_period_start??0).utc(),y=eP.default.unix(u?.current_period_end??0).utc(),f=y.diff((0,eP.default)(),"days"),j=y.diff(x,"days");return(0,t.jsxs)(r.ScaffoldSection,{children:[(0,t.jsx)(r.ScaffoldSectionDetail,{children:(0,t.jsxs)("div",{className:"sticky space-y-2 top-12 pr-6",children:[(0,t.jsx)("p",{className:"text-foreground text-base m-0",children:"Upcoming Invoice"}),(0,t.jsx)("div",{className:"py-2",children:a?.managed_by!==ei.MANAGED_BY.AWS_MARKETPLACE&&(0,t.jsx)(eU.default,{type:"horizontal",value:j-f,max:j,barClass:"bg-foreground",labelBottom:`${x.format("MMMM DD")} - ${y.format("MMMM DD")}`,bgClass:"bg-surface-300",labelBottomClass:"!text-foreground-light p-1 m-0",labelTop:u?`${f} ${1===f?"day":"days"} left`:"",labelTopClass:"p-1 m-0"})}),(0,t.jsx)("p",{className:"prose text-sm",children:a?.managed_by===ei.MANAGED_BY.AWS_MARKETPLACE?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("p",{children:"AWS Marketplace sends two invoices each month: one for your fixed subscription fee, billed on the day you subscribed, and one for your usage charges from the previous month, billed by the 3rd."}),(0,t.jsxs)("p",{children:["For a more detailed breakdown, visit the"," ",(0,t.jsx)(eO.default,{href:`/org/${e}/usage`,children:"usage page."})]})]}):(0,t.jsxs)(t.Fragment,{children:["Your upcoming invoice (excluding credits) will continue to update until the end of your billing cycle on ",y.format("MMMM DD"),". For a more detailed breakdown, visit the ",(0,t.jsx)(eO.default,{href:`/org/${e}/usage`,children:"usage page."})]})}),(0,t.jsx)("br",{}),(0,t.jsx)("p",{className:"text-sm text-foreground-light mt-4",children:"Add-on changes or new projects may take up to an hour to appear."})]})}),(0,t.jsx)(r.ScaffoldSectionContent,{children:s&&!d?(0,t.jsx)(ee.default,{resourceText:"view this organization's upcoming invoice"}):(0,t.jsxs)(t.Fragment,{children:[p&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(Q.ShimmeringLoader,{}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-3/4"}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-1/2"})]}),h&&(0,t.jsx)(X.default,{subject:"Failed to retrieve subscription",error:m}),g&&(0,t.jsx)(eV,{slug:e})]})})]})};var eH=e.i(428353),eX=e.i(370410),eJ=e.i(365257),eZ=e.i(975924),e0=e.i(97429),e2=e.i(866205),e1=e.i(703526),e4=e.i(917007),e3=e.i(920432),e5=e.i(549815),e8=e.i(911509),e6=e.i(24315),e9=e.i(61863),e7=e.i(846887),ae=e.i(378277),aa=e.i(689805),at=e.i(793912),as=e.i(135144),ai=e.i(538482),ar=e.i(256032),an=e.i(145831);let al=e0.z.object({billing_name:e0.z.string().min(3,"Name must be at least 3 letters long"),line1:e0.z.string().trim().min(3,"Address line 1 is required"),line2:e0.z.string().optional(),city:e0.z.string().trim().min(2,"City is required"),state:e0.z.string().trim(),postal_code:e0.z.string().trim().min(1,"Postal code is required"),country:e0.z.string().trim().min(1,"Country is required"),tax_id_type:e0.z.string(),tax_id_value:e0.z.string(),tax_id_name:e0.z.string()}),ao=({form:e,disabled:a=!1,className:i})=>{let[r,n]=(0,s.useState)(!1),[l,o]=(0,s.useState)(!1),{tax_id_name:c,country:u}=e.watch(),m=an.TAX_IDS.find(e=>e.name===c),p=(0,s.useMemo)(()=>an.TAX_IDS.filter(e=>!u||e.countryIso2===u).sort((e,a)=>e.country.localeCompare(a.country)),[u]);return(0,t.jsxs)("div",{className:(0,d.cn)("flex flex-col space-y-4",i),children:[(0,t.jsx)(e9.FormField_Shadcn_,{control:e.control,name:"billing_name",render:({field:e})=>(0,t.jsxs)(ai.FormItemLayout,{hideMessage:!0,label:"Name",children:[(0,t.jsx)(e6.FormControl_Shadcn_,{children:(0,t.jsx)(ae.Input_Shadcn_,{...e,disabled:a})}),(0,t.jsx)(e7.FormMessage_Shadcn_,{})]})}),(0,t.jsx)(e9.FormField_Shadcn_,{control:e.control,name:"line1",render:({field:e})=>(0,t.jsxs)(ai.FormItemLayout,{hideMessage:!0,label:"Address line 1",children:[(0,t.jsx)(e6.FormControl_Shadcn_,{children:(0,t.jsx)(ae.Input_Shadcn_,{...e,placeholder:"123 Main Street",disabled:a})}),(0,t.jsx)(e7.FormMessage_Shadcn_,{})]})}),(0,t.jsx)(e9.FormField_Shadcn_,{control:e.control,name:"line2",render:({field:e})=>(0,t.jsxs)(ai.FormItemLayout,{hideMessage:!0,label:"Address line 2 (optional)",children:[(0,t.jsx)(e6.FormControl_Shadcn_,{children:(0,t.jsx)(ae.Input_Shadcn_,{...e,placeholder:"Apartment, suite, unit, building, floor, etc.",disabled:a})}),(0,t.jsx)(e7.FormMessage_Shadcn_,{})]})}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsx)(e9.FormField_Shadcn_,{control:e.control,name:"country",render:({field:s})=>(0,t.jsxs)(ai.FormItemLayout,{hideMessage:!0,label:"Country",children:[(0,t.jsxs)(aa.Popover_Shadcn_,{open:r,onOpenChange:n,children:[(0,t.jsx)(as.PopoverTrigger_Shadcn_,{asChild:!0,children:(0,t.jsx)(e6.FormControl_Shadcn_,{children:(0,t.jsx)(q.Button,{type:"default",role:"combobox",size:"medium",disabled:a,className:(0,d.cn)("w-full justify-between h-[34px]",!s.value&&"text-muted"),iconRight:(0,t.jsx)(eJ.ChevronsUpDown,{className:"ml-2 h-4 w-4 shrink-0 opacity-50",strokeWidth:1.5}),children:s.value&&ar.COUNTRIES.find(e=>e.code===s.value)?.name||"Select country"})})}),(0,t.jsx)(at.PopoverContent_Shadcn_,{sameWidthAsTrigger:!0,className:"p-0",align:"start",children:(0,t.jsxs)(e2.Command_Shadcn_,{children:[(0,t.jsx)(e3.CommandInput_Shadcn_,{placeholder:"Search country..."}),(0,t.jsxs)(e8.CommandList_Shadcn_,{children:[(0,t.jsx)(e1.CommandEmpty_Shadcn_,{children:"No country found."}),(0,t.jsx)(e4.CommandGroup_Shadcn_,{children:ar.COUNTRIES.map(a=>(0,t.jsxs)(e5.CommandItem_Shadcn_,{value:a.name,onSelect:()=>{e.setValue("country",a.code,{shouldDirty:!0,shouldTouch:!0,shouldValidate:!0}),n(!1)},children:[(0,t.jsx)(eX.Check,{className:(0,d.cn)("mr-2 h-4 w-4",s.value===a.code?"opacity-100":"opacity-0")}),a.name]},a.code))})]})]})})]}),(0,t.jsx)(e7.FormMessage_Shadcn_,{})]})}),(0,t.jsx)(e9.FormField_Shadcn_,{control:e.control,name:"postal_code",render:({field:e})=>(0,t.jsxs)(ai.FormItemLayout,{hideMessage:!0,label:"Postal code",children:[(0,t.jsx)(e6.FormControl_Shadcn_,{children:(0,t.jsx)(ae.Input_Shadcn_,{...e,placeholder:"12345",disabled:a})}),(0,t.jsx)(e7.FormMessage_Shadcn_,{})]})})]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsx)(e9.FormField_Shadcn_,{control:e.control,name:"city",render:({field:e})=>(0,t.jsxs)(ai.FormItemLayout,{hideMessage:!0,label:"City",children:[(0,t.jsx)(e6.FormControl_Shadcn_,{children:(0,t.jsx)(ae.Input_Shadcn_,{...e,disabled:a})}),(0,t.jsx)(e7.FormMessage_Shadcn_,{})]})}),(0,t.jsx)(e9.FormField_Shadcn_,{control:e.control,name:"state",render:({field:e})=>(0,t.jsxs)(ai.FormItemLayout,{hideMessage:!0,label:"State / Province",children:[(0,t.jsx)(e6.FormControl_Shadcn_,{children:(0,t.jsx)(ae.Input_Shadcn_,{...e,disabled:a})}),(0,t.jsx)(e7.FormMessage_Shadcn_,{})]})})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-x-2 w-full items-end",children:[(0,t.jsx)(e9.FormField_Shadcn_,{name:"tax_id_name",control:e.control,render:()=>(0,t.jsxs)(ai.FormItemLayout,{hideMessage:!0,layout:"vertical",label:"Tax ID",children:[(0,t.jsxs)(aa.Popover_Shadcn_,{open:l,onOpenChange:o,children:[(0,t.jsx)(as.PopoverTrigger_Shadcn_,{asChild:!0,children:(0,t.jsx)(e6.FormControl_Shadcn_,{children:(0,t.jsx)(q.Button,{type:"default",role:"combobox",size:"medium",disabled:a,className:(0,d.cn)("w-full justify-between h-[34px] pr-2",!m&&"text-muted"),iconRight:(0,t.jsx)(eJ.ChevronsUpDown,{className:"h-4 w-4 shrink-0 opacity-50",strokeWidth:1.5}),children:m?`${m.country} - ${m.name}`:"Select tax ID"})})}),(0,t.jsx)(at.PopoverContent_Shadcn_,{sameWidthAsTrigger:!0,className:"p-0",align:"start",children:(0,t.jsxs)(e2.Command_Shadcn_,{children:[(0,t.jsx)(e3.CommandInput_Shadcn_,{placeholder:"Search tax ID..."}),(0,t.jsxs)(e8.CommandList_Shadcn_,{children:[(0,t.jsx)(e1.CommandEmpty_Shadcn_,{children:"No tax ID found."}),(0,t.jsx)(e4.CommandGroup_Shadcn_,{children:p.map(a=>(0,t.jsxs)(e5.CommandItem_Shadcn_,{value:`${a.country} - ${a.name}`,onSelect:()=>{var t;let s;t=a.name,(s=an.TAX_IDS.find(e=>e.name===t))&&(e.setValue("tax_id_type",s.type),e.setValue("tax_id_value",""),e.setValue("tax_id_name",t)),o(!1)},children:[(0,t.jsx)(eX.Check,{className:(0,d.cn)("mr-2 h-4 w-4",m?.name===a.name?"opacity-100":"opacity-0")}),a.country," - ",a.name]},a.name))})]})]})})]}),(0,t.jsx)(e7.FormMessage_Shadcn_,{})]})}),m&&(0,t.jsxs)("div",{className:"flex items-center space-x-2 [&>div]:w-full",children:[(0,t.jsx)(e9.FormField_Shadcn_,{name:"tax_id_value",control:e.control,render:({field:e})=>(0,t.jsx)(ai.FormItemLayout,{hideMessage:!0,children:(0,t.jsx)(e6.FormControl_Shadcn_,{children:(0,t.jsx)(ae.Input_Shadcn_,{...e,disabled:a,placeholder:m?.placeholder})})})}),(0,t.jsx)(q.Button,{type:"text",className:"px-1",icon:(0,t.jsx)(eZ.X,{}),onClick:()=>void(e.setValue("tax_id_name","",{shouldDirty:!0}),e.setValue("tax_id_type","",{shouldDirty:!0}),e.setValue("tax_id_value","",{shouldDirty:!0}))})]})]})]})};var ad=e.i(532728),ac=e.i(408891);let au=()=>{let{slug:e}=(0,i.useParams)(),{data:a}=(0,o.useSelectedOrganizationQuery)(),{can:n,isSuccess:l}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.BILLING_READ,"stripe.customer"),{can:d}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.BILLING_WRITE,"stripe.customer"),{data:u,error:m,isPending:p,isSuccess:g}=k({slug:e},{enabled:n}),{data:x,error:y,isPending:f,isSuccess:j}=R({slug:e}),b=(0,s.useMemo)(()=>({city:u?.address?.city??void 0,country:u?.address?.country,line1:u?.address?.line1,line2:u?.address?.line2??void 0,postal_code:u?.address?.postal_code??void 0,state:u?.address?.state??void 0,billing_name:u?.billing_name,tax_id_type:x?.type,tax_id_value:x?.value,tax_id_name:x&&an.TAX_IDS.find(e=>e.type===x.type&&e.countryIso2===x.country)?.name||""}),[u,x]),{mutateAsync:_}=L(),{mutateAsync:v}=U(),[S,N]=(0,s.useState)(!1),{form:C,handleSubmit:w,handleReset:P,isDirty:T}=function({initialCustomerData:e,onCustomerDataChange:a}){let t=(0,ac.useForm)({resolver:(0,ad.zodResolver)(al),defaultValues:{billing_name:e?.billing_name||"",line1:e?.line1||"",line2:e?.line2||"",city:e?.city||"",state:e?.state||"",postal_code:e?.postal_code||"",country:e?.country||"",tax_id_type:e?.tax_id_type||"",tax_id_value:e?.tax_id_value||"",tax_id_name:e?.tax_id_name||""}});(0,s.useEffect)(()=>{e&&t.reset({billing_name:e.billing_name||"",line1:e.line1||"",line2:e.line2||"",city:e.city||"",state:e.state||"",postal_code:e.postal_code||"",country:e.country||"",tax_id_type:e?.tax_id_type||"",tax_id_value:e?.tax_id_value||"",tax_id_name:e?.tax_id_name||""})},[e]);let i=async e=>{var s;let i,r,n=Object.entries(e).reduce((e,[a,t])=>(e[a]="string"==typeof t?t.trim():t,e),{}),l=n.line1?n:null,o=an.TAX_IDS.find(a=>a.name===e.tax_id_name);a({address:l?{line1:n.line1,line2:n.line2,city:n.city,state:n.state,postal_code:n.postal_code,country:n.country}:void 0,billing_name:n.billing_name,tax_id:o&&e.tax_id_type?.length&&e.tax_id_value?.length?{type:e.tax_id_type,value:(s={value:e.tax_id_value,name:t.getValues().tax_id_name},i=an.TAX_IDS.find(e=>e.name===s.name),(r=i?.vatPrefix)&&!s.value.startsWith(r)?`${r}${s.value}`:s.value),country:o?.countryIso2}:null})};return{form:t,handleSubmit:i,handleReset:()=>{e?t.reset({billing_name:e.billing_name||"",line1:e.line1||"",line2:e.line2||"",city:e.city||"",state:e.state||"",postal_code:e.postal_code||"",country:e.country||"",tax_id_type:e?.tax_id_type||"",tax_id_value:e?.tax_id_value||"",tax_id_name:e?.tax_id_name||""}):t.reset({line1:"",line2:"",city:"",state:"",postal_code:"",country:"",tax_id_type:"",tax_id_value:"",tax_id_name:""})},isDirty:t.formState.isDirty}}({initialCustomerData:b,onCustomerDataChange:async a=>{N(!0);try{await _({slug:e,address:a.address,billing_name:a.billing_name}),await v({slug:e,taxId:a.tax_id}),h.toast.success("Successfully updated billing data"),N(!1)}catch(e){h.toast.error(`Failed updating billing data: ${e.message}`),N(!1)}}}),A=!T||!d||S;return(0,t.jsxs)(r.ScaffoldSection,{children:[(0,t.jsx)(r.ScaffoldSectionDetail,{children:(0,t.jsxs)("div",{className:"sticky space-y-2 top-12 pr-3",children:[(0,t.jsx)("p",{className:"text-foreground text-base m-0",children:"Billing Address & Tax ID"}),(0,t.jsx)("p",{className:"text-sm text-foreground-light m-0",children:"Changes will be reflected in every upcoming invoice, past invoices are not affected"}),(0,t.jsx)("p",{className:"text-sm text-foreground-light m-0",children:"A Tax ID is only required for registered businesses."})]})}),(0,t.jsx)(r.ScaffoldSectionContent,{children:a?.managed_by!==void 0&&a?.managed_by!=="supabase"?(0,t.jsx)(ea.default,{managedBy:a?.managed_by,resource:"Billing Addresses",cta:{installationId:a?.partner_id}}):l&&!n?(0,t.jsx)(ee.default,{resourceText:"view this organization's billing address"}):(0,t.jsxs)(t.Fragment,{children:[(p||f)&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(Q.ShimmeringLoader,{}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-3/4"}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-1/2"})]}),(m||y)&&(0,t.jsx)(X.default,{subject:"Failed to retrieve organization customer profile",error:m||y}),g&&j&&(0,t.jsx)(eM.Card,{children:(0,t.jsx)(eH.Form_Shadcn_,{...C,children:(0,t.jsxs)("form",{onSubmit:C.handleSubmit(w),children:[(0,t.jsx)(ao,{className:"p-8",form:C,disabled:!d}),(0,t.jsxs)(eM.CardFooter,{className:"border-t justify-end px-8",children:[!d&&(0,t.jsx)("span",{className:"text-sm text-foreground-lighter mr-auto",children:"You need additional permissions to manage this organization's billing address"}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(q.Button,{type:"default",onClick:P,disabled:A,children:"Cancel"}),(0,t.jsx)(q.Button,{type:"primary",htmlType:"submit",disabled:A,loading:S,children:"Save"})]})]})]})})})]})})]})};var am=e.i(20482),ap=e.i(331720),ah=e.i(775465),ag=e.i(884860);let ax="org-billing-email",ay=e0.z.object({billingEmail:e0.z.string().email("Please provide a valid email address").optional(),additionalBillingEmails:e0.z.string().email({message:"invalid_email"}).array().default([])}),af=()=>{let{slug:e}=(0,i.useParams)(),{data:a}=(0,o.useSelectedOrganizationQuery)(),{name:n,billing_email:l}=a??{},{can:d,isSuccess:u}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.BILLING_READ,"stripe.subscriptions"),{can:m}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.UPDATE,"organizations"),{data:p,isPending:g}=k({slug:e},{enabled:d}),x=(0,ac.useForm)({resolver:(0,ad.zodResolver)(ay),defaultValues:{billingEmail:l??"",additionalBillingEmails:p?.additional_emails??[]}}),{additionalBillingEmails:y}=x.watch(),{errors:f}=x.formState,j=f.additionalBillingEmails??[],{mutate:b,isPending:_}=(0,ah.useOrganizationUpdateMutation)(),v=async a=>m?e?n?void b({slug:e,name:n,billing_email:a.billingEmail,additional_billing_emails:a.additionalBillingEmails},{onSuccess:()=>{h.toast.success("Successfully saved settings"),x.reset(a)}}):console.error("Organization name is required"):console.error("Slug is required"):h.toast.error("You do not have the required permissions to update this organization");return(0,s.useEffect)(()=>{p&&x.reset({billingEmail:l??"",additionalBillingEmails:p.additional_emails??[]})},[p]),(0,t.jsxs)(r.ScaffoldSection,{children:[(0,t.jsx)(r.ScaffoldSectionDetail,{children:(0,t.jsxs)("div",{className:"sticky space-y-2 top-12",children:[(0,t.jsx)("p",{className:"text-foreground text-base m-0",children:"Email Recipient"}),(0,t.jsx)("p",{className:"text-sm text-foreground-light m-0",children:"All billing correspondence will go to this email"})]})}),(0,t.jsx)(r.ScaffoldSectionContent,{children:u&&!d?(0,t.jsx)(ee.default,{resourceText:"view this organization's email recipients"}):(0,t.jsx)(am.Form,{...x,children:(0,t.jsx)("form",{id:ax,onSubmit:x.handleSubmit(v),children:(0,t.jsx)(J.FormPanel,{footer:(0,t.jsx)("div",{className:"flex py-4 px-[var(--card-padding-x)]",children:(0,t.jsx)(ap.FormActions,{form:ax,isSubmitting:_,hasChanges:x.formState.isDirty,handleReset:x.reset,disabled:!m,helper:m?void 0:"You need additional permissions to update billing emails"})}),children:(0,t.jsx)(Z.FormSection,{children:(0,t.jsxs)(Z.FormSectionContent,{fullWidth:!0,loading:g,children:[(0,t.jsx)(am.FormField,{control:x.control,name:"billingEmail",render:({field:e})=>(0,t.jsxs)(ai.FormItemLayout,{label:"Email address",children:[(0,t.jsx)(am.FormControl,{children:(0,t.jsx)(ae.Input_Shadcn_,{type:"email",...e,placeholder:"Email",disabled:!m})}),(0,t.jsx)(e7.FormMessage_Shadcn_,{})]})}),(0,t.jsx)(am.FormField,{control:x.control,name:"additionalBillingEmails",render:({field:e})=>(0,t.jsxs)(ai.FormItemLayout,{hideMessage:!0,label:(0,t.jsxs)("div",{className:"flex items-center gap-x-1",children:[(0,t.jsx)("span",{children:"Additional emails"}),(0,t.jsx)(e$.InfoTooltip,{side:"bottom",children:"These email addresses will be CC'd in automated invoice or payment failure emails. Payment receipts will still only go to the primary billing address."})]}),children:[(0,t.jsx)(am.FormControl,{children:(0,t.jsxs)(ag.MultiSelector,{values:e.value,onValuesChange:e.onChange,children:[(0,t.jsx)(ag.MultiSelectorTrigger,{deletableBadge:!0,showIcon:!1,mode:"inline-combobox",label:"Add additional recipients",badgeLimit:"wrap"}),(0,t.jsx)(ag.MultiSelectorContent,{children:(0,t.jsx)(ag.MultiSelectorList,{creatable:!0})})]})}),Array.isArray(j)&&j.length>0&&(0,t.jsx)("div",{className:"flex flex-col gap-y-1 mt-2",children:j.map((e,a)=>(0,t.jsxs)("p",{className:"text-sm text-destructive",children:['"',y[a],'" is not a valid email address']},`email-error-${a}`))})]})})]})})})})})})]})};var aj=e.i(17203),ab=e.i(994110),a_=e.i(657588),av=e.i(912971),aS=e.i(991435),aN=e.i(416785);let aC=(0,aS.proxy)({panelKey:void 0,setPanelKey:e=>{aC.panelKey=e}}),aw=e=>(0,aN.useSnapshot)(aC,e);var aP=e.i(93472),aT=e.i(592360),aA=e.i(178527),aE=e.i(637371),aI=e.i(707843),ak=e.i(557282),aM=e.i(795513);async function aL({slug:e,tier:a,paymentMethod:t,address:s,tax_id:i,billing_name:r}){if(!e)throw Error("slug is required");if(!a)throw Error("tier is required");let n={tier:a};void 0!==t&&(n.payment_method=t);let{error:l,data:o}=await (0,_.put)("/platform/organizations/{slug}/billing/subscription",{body:{payment_method:n.payment_method,tier:n.tier,address:s??void 0,tax_id:i??void 0,billing_name:r},params:{path:{slug:e}}});return l&&(0,_.handleError)(l),o}let aF=({onSuccess:e,onError:a,...t}={})=>{let s=(0,C.useQueryClient)();return(0,b.useMutation)({mutationFn:e=>aL(e),async onSuccess(a,t,i){let{slug:r}=t;!a.pending_payment_intent_secret&&(await new Promise(e=>setTimeout(e,2e3)),await Promise.all([s.invalidateQueries({queryKey:aM.subscriptionKeys.orgSubscription(r)}),s.invalidateQueries({queryKey:aM.subscriptionKeys.orgPlans(r)}),s.invalidateQueries({queryKey:ak.usageKeys.orgUsage(r)}),s.invalidateQueries({queryKey:ev.invoicesKeys.orgUpcomingPreview(r)}),s.invalidateQueries({queryKey:P.organizationKeys.detail(r)}),s.invalidateQueries({queryKey:P.organizationKeys.list()}),s.invalidateQueries({queryKey:P.organizationKeys.entitlements(r)})]),t.paymentMethod&&s.setQueriesData({queryKey:P.organizationKeys.paymentMethods(r)},e=>e?{...e,defaultPaymentMethodId:t.paymentMethod,data:e.data.map(e=>({...e,is_default:e.id===t.paymentMethod}))}:e)),await e?.(a,t,i)},async onError(e,t,s){void 0===a?h.toast.error(e.message,{dismissible:!0,duration:1e4}):a(e,t,s)},...t})};var aD=e.i(199454),az=e.i(58359),aR=e.i(539013);let aO=[{name:"Spend cap enabled",value:"on",imageUrl:`${N.BASE_PATH}/img/spend-cap-on.png`,imageUrlLight:`${N.BASE_PATH}/img/spend-cap-on--light.png`},{name:"Spend cap disabled",value:"off",imageUrl:`${N.BASE_PATH}/img/spend-cap-off.png`,imageUrlLight:`${N.BASE_PATH}/img/spend-cap-off--light.png`}],aU=()=>{let{slug:e}=(0,i.useParams)(),{resolvedTheme:a}=(0,f.useTheme)(),[r,l]=(0,s.useState)(!1),[o,u]=(0,s.useState)(),{can:m}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.BILLING_WRITE,"stripe.subscriptions"),p=aw(),g="costControl"===p.panelKey,x=()=>p.setPanelKey(void 0),{data:y,isPending:j}=(0,n.useOrgSubscriptionQuery)({orgSlug:e}),{mutate:b,isPending:_}=aF({onSuccess:()=>{h.toast.success(`Successfully ${C?"enabled":"disabled"} spend cap`),x()},onError:e=>{h.toast.error(`Failed to toggle spend cap: ${e.message}`)}}),v=y?.plan?.id==="free",S=!y?.usage_billing_enabled,C=!S&&"on"===o,w=o!==(S?"on":"off");(0,s.useEffect)(()=>{g&&void 0!==y&&u(S?"on":"off")},[g,j,y,S]);let P=async()=>{if(!e)return console.error("Org slug is required");b({slug:e,tier:"on"===o?ei.PRICING_TIER_PRODUCT_IDS.PRO:ei.PRICING_TIER_PRODUCT_IDS.PAYG})};return(0,t.jsx)(aR.SidePanel,{size:"large",loading:j||_,disabled:v||j||!w||_||!m,visible:g,onCancel:x,onConfirm:P,header:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("h4",{children:"Spend cap"}),(0,t.jsx)(q.Button,{asChild:!0,type:"default",icon:(0,t.jsx)(aj.ExternalLink,{strokeWidth:1.5}),children:(0,t.jsx)(eO.default,{href:`${N.DOCS_URL}/guides/platform/cost-control#spend-cap`,target:"_blank",rel:"noreferrer",children:"About spend cap"})})]}),tooltip:m?void 0:"You do not have permission to update spend cap",children:(0,t.jsx)(aR.SidePanel.Content,{children:(0,t.jsxs)("div",{className:"py-6 space-y-4",children:[(0,t.jsx)("p",{className:"text-sm",children:"Use the spend cap to manage project usage and costs, and control whether the project can exceed the included quota allowance of any billed line item in a billing cycle"}),(0,t.jsxs)(az.Collapsible,{open:r,onOpenChange:l,children:[(0,t.jsx)(az.Collapsible.Trigger,{asChild:!0,children:(0,t.jsxs)("div",{className:"flex items-center space-x-2 cursor-pointer",children:[(0,t.jsx)(eA.ChevronRight,{strokeWidth:1.5,size:16,className:r?"rotate-90":""}),(0,t.jsx)("p",{className:"text-sm text-foreground-light",children:"How are each resource charged after exceeding the included quota?"})]})}),(0,t.jsx)(az.Collapsible.Content,{asChild:!0,children:(0,t.jsx)(aI.default,{className:"mt-4",head:(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(aI.default.th,{children:(0,t.jsx)("p",{className:"text-xs",children:"Item"})}),(0,t.jsx)(aI.default.th,{children:(0,t.jsx)("p",{className:"text-xs",children:"Rate"})})]}),body:["database","auth","storage","realtime","edge_functions"].map(e=>{let a=aD.pricing[e],s=a.features.filter(e=>e.usage_based);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(aI.default.tr,{children:[(0,t.jsx)(aI.default.td,{children:(0,t.jsx)("p",{className:"text-xs text-foreground",children:a.title})}),(0,t.jsx)(aI.default.td,{children:null})]},e),s.map(e=>(0,t.jsxs)(aI.default.tr,{children:[(0,t.jsx)(aI.default.td,{children:(0,t.jsx)("p",{className:"text-xs pl-4",children:e.title})}),(0,t.jsx)(aI.default.td,{children:(0,t.jsx)("p",{className:"text-xs pl-4",children:e.plans.pro})})]},e.title))]})})})})]}),v&&(0,t.jsx)(en.Admonition,{type:"note",layout:"horizontal",title:"Toggling of the spend cap is only available on the Pro Plan",description:"Upgrade your plan to disable the spend cap",actions:(0,t.jsx)(q.Button,{type:"default",onClick:()=>p.setPanelKey("subscriptionPlan"),children:"View available plans"})}),(0,t.jsx)("div",{className:"!mt-8 pb-4",children:(0,t.jsx)("div",{className:"flex gap-3",children:aO.map(e=>{let s=o===e.value;return(0,t.jsxs)("div",{className:(0,d.cn)("col-span-4 group space-y-1",v&&"opacity-75"),onClick:()=>!v&&u(e.value),children:[(0,t.jsx)(ab.default,{alt:"Spend Cap",className:(0,d.cn)("relative rounded-xl transition border bg-no-repeat bg-center bg-cover w-[160px] h-[96px]",s?"border-foreground":"border-foreground-muted opacity-50 group-hover:border-foreground-lighter group-hover:opacity-100",!v&&"cursor-pointer",!v&&!s&&"group-hover:border-foreground-light"),width:160,height:96,src:a?.includes("dark")?e.imageUrl:e.imageUrlLight}),(0,t.jsx)("p",{className:(0,d.cn)("text-sm transition",!v&&"group-hover:text-foreground",s?"text-foreground":"text-foreground-light"),children:e.name})]},e.value)})})}),"on"===o?(0,t.jsx)(en.Admonition,{type:"warning",title:"Your projects could become unresponsive or enter read only mode",description:"Exceeding the included quota allowance with spend cap enabled can cause your projects to become unresponsive or enter read only mode."}):(0,t.jsx)(en.Admonition,{type:"note",title:"Charges apply for usage beyond included quota allowance",description:"Your projects will always remain responsive and active, and charges only apply when exceeding the included quota limit."}),w&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("p",{className:"text-sm",children:"on"===o?"Upon clicking confirm, spend cap will be enabled for your organization and you will no longer be charged any extra for usage.":"Upon clicking confirm, spend cap will be disabled for your organization and you will be charged for any usage beyond the included quota."}),(0,t.jsx)("p",{className:"text-sm",children:"Toggling spend cap triggers an invoice and there might be prorated charges for any usage beyond the Pro Plans quota during this billing cycle."})]})]})})})},aB=({})=>{let{slug:e}=(0,i.useParams)(),{resolvedTheme:a}=(0,f.useTheme)(),{data:s}=(0,o.useSelectedOrganizationQuery)(),{isSuccess:l,can:d}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.BILLING_READ,"stripe.subscriptions"),u=aw(),m=(0,a_.useFlag)("disableProjectCreationAndUpdate"),{data:p,error:h,isPending:g,isSuccess:x,isError:y}=(0,n.useOrgSubscriptionQuery)({orgSlug:e},{enabled:d}),j=p?.plan,b=p?.usage_billing_enabled??!1,_=!m&&!["team","enterprise","platform"].includes(j?.id||""),v=s?.managed_by===ei.MANAGED_BY.AWS_MARKETPLACE;return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(r.ScaffoldSection,{children:[(0,t.jsx)(r.ScaffoldSectionDetail,{children:(0,t.jsxs)("div",{className:"sticky space-y-6 top-12",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("p",{className:"text-foreground text-base m-0",children:"Cost Control"}),(0,t.jsxs)("p",{className:"text-sm text-foreground-light m-0",children:["Allow scaling beyond your plan's"," ",(0,t.jsx)(eO.default,{href:`/org/${e}/usage`,className:"text-green-900 transition hover:text-green-1000",children:"included quota"}),"."]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("p",{className:"text-sm text-foreground-light m-0",children:"More information"}),(0,t.jsx)("div",{children:(0,t.jsx)(eO.default,{href:`${N.DOCS_URL}/guides/platform/cost-control#spend-cap`,target:"_blank",rel:"noreferrer",children:(0,t.jsxs)("div",{className:"flex items-center space-x-2 opacity-50 hover:opacity-100 transition",children:[(0,t.jsx)("p",{className:"text-sm m-0",children:"Spend cap"}),(0,t.jsx)(aj.ExternalLink,{size:16,strokeWidth:1.5})]})})})]})]})}),(0,t.jsx)(r.ScaffoldSectionContent,{children:l&&!d?(0,t.jsx)(ee.default,{resourceText:"update this organization's cost control"}):(0,t.jsxs)(t.Fragment,{children:[g&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(Q.ShimmeringLoader,{}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-3/4"}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-1/2"})]}),y&&(0,t.jsx)(X.default,{subject:"Failed to retrieve subscription",error:h}),x&&v&&(0,t.jsxs)(aA.Alert_Shadcn_,{className:"flex flex-col items-center gap-y-2 border-0 rounded-none",children:[(0,t.jsx)(av.default,{organization:{managed_by:s?.managed_by},showTooltip:!1,size:"large"}),(0,t.jsxs)(aT.AlertTitle_Shadcn_,{className:"text-sm",children:["The Spend Cap is not available for organizations managed by"," ",ea.PARTNER_TO_NAME[s?.managed_by],"."]})]}),x&&!v&&(0,t.jsxs)("div",{className:"space-y-6",children:[["team","enterprise","platform"].includes(j?.id||"")?(0,t.jsxs)(aP.Alert,{withIcon:!0,variant:"info",title:`You will be charged for any additional usage on the ${j?.name||""} plan`,children:[j?.name||""," plan requires you to have spend cap off at all times. Your projects will never become unresponsive. Only when your"," ",(0,t.jsx)(eO.default,{href:`/org/${e}/usage`,className:"text-green-900 transition hover:text-green-1000",children:"included usage"})," ","is exceeded will you be charged for any additional usage."]}):(0,t.jsx)("p",{className:"text-sm text-foreground-light",children:"If you need to go beyond the included quota, simply switch off your spend cap to pay for additional usage."}),(0,t.jsxs)("div",{className:"flex flex-col md:flex-row gap-6",children:[(0,t.jsx)("div",{children:(0,t.jsx)("div",{className:"rounded-md bg-surface-200 w-[160px] h-[96px] shadow",children:(0,t.jsx)(ab.default,{alt:"Spend Cap",width:160,height:96,src:b?`${N.BASE_PATH}/img/spend-cap-off${a?.includes("dark")?"":"--light"}.png`:`${N.BASE_PATH}/img/spend-cap-on${a?.includes("dark")?"":"--light"}.png`})})}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("p",{className:"mb-1",children:["Spend cap is ",b?"disabled":"enabled"]}),(0,t.jsx)("p",{className:"text-sm text-foreground-light",children:b?(0,t.jsx)("span",{children:"You will be charged for usage beyond the included quota."}):(0,t.jsx)("span",{children:"You won't be charged any extra for usage. However, your projects could become unresponsive or enter read only mode if you exceed the included quota."})}),(0,t.jsx)(aE.default,{projectUpdateDisabled:m,children:(0,t.jsx)(q.Button,{type:"default",className:"mt-4 pointer-events-auto",disabled:!_,onClick:()=>u.setPanelKey("costControl"),children:"Change spend cap"})})]})]})]})]})})]}),(0,t.jsx)(aU,{})]})};var aq=e.i(93558),a$=e.i(867637),aK=e.i(971687);let aQ=(0,u.default)("PartyPopper",[["path",{d:"M5.8 11.3 2 22l10.7-3.79",key:"gwxi1d"}],["path",{d:"M4 3h.01",key:"1vcuye"}],["path",{d:"M22 8h.01",key:"1mrtc2"}],["path",{d:"M15 2h.01",key:"1cjtqr"}],["path",{d:"M22 20h.01",key:"1mrys2"}],["path",{d:"m22 2-2.24.75a2.9 2.9 0 0 0-1.96 3.12c.1.86-.57 1.63-1.45 1.63h-.38c-.86 0-1.6.6-1.76 1.44L14 10",key:"hbicv8"}],["path",{d:"m22 13-.82-.33c-.86-.34-1.82.2-1.98 1.11c-.11.7-.72 1.22-1.43 1.22H17",key:"1i94pl"}],["path",{d:"m11 2 .33.82c.34.86-.2 1.82-1.11 1.98C9.52 4.9 9 5.52 9 6.23V7",key:"1cofks"}],["path",{d:"M11 13c1.93 1.93 2.83 4.17 2 5-.83.83-3.07-.07-5-2-1.93-1.93-2.83-4.17-2-5 .83-.83 3.07.07 5 2Z",key:"4kbmks"}]]);var aY=e.i(271226),aG=e.i(206413),aV=e.i(253214),aW=e.i(479095);async function aH({hcaptchaToken:e,code:a,slug:t}){if(!e)throw Error("Captcha not submitted");if(!t)throw Error("Slug is required");let{data:s,error:i}=await (0,_.post)("/platform/organizations/{slug}/billing/credits/redeem",{params:{path:{slug:t}},body:{hcaptcha_token:e,code:a}});return i&&(0,_.handleError)(i),s}var aX=e.i(323796);let aJ=e0.z.object({code:e0.z.coerce.string()}),aZ=({slug:e,modalVisible:a=!1})=>{let{can:i,isSuccess:r}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.BILLING_WRITE,"stripe.subscriptions"),n=(0,a_.useFlag)("redeemCodeEnabled"),{data:l,isLoading:d}=(0,o.useSelectedOrganizationQuery)({}),u=(0,aY.useRouter)(),m=(0,ac.useForm)({resolver:(0,ad.zodResolver)(aJ),defaultValues:{code:""}}),{data:p,isLoading:h}=k({slug:e});(0,s.useEffect)(()=>{if(!u.isReady)return;let e=u.query.code,a=Array.isArray(e)?e[0]:e;"string"==typeof a&&a.trim().length>2&&m.setValue("code",a)},[u.isReady,u.query.code,m]);let[x,y]=(0,s.useState)(a||!1),f=(0,s.useRef)(null),j=(0,s.useRef)(null),{mutateAsync:_,isPending:v,error:S,data:N,reset:w}=(({onSuccess:e,onError:a,...t}={})=>{let s=(0,C.useQueryClient)();return(0,b.useMutation)({mutationFn:e=>aH(e),async onSuccess(a,t,i){let{slug:r,code:n}=t;await s.invalidateQueries({queryKey:P.organizationKeys.customerProfile(r)}),await s.invalidateQueries({queryKey:aM.subscriptionKeys.orgSubscription(r)}),await s.invalidateQueries({queryKey:P.organizationKeys.previewCreditCode(r,n)}),await e?.(a,t,i)},async onError(e,t,s){void 0!==a&&a(e,t,s)},...t})})(),T=()=>{j.current=null,f.current?.resetCaptcha()},A=async()=>{let e=j.current;try{if(!e){let a=await f.current?.execute({async:!0});j.current=e=a?.response??null}}catch(e){}return e},I=(0,aX.default)(A);(0,s.useEffect)(()=>{x&&I.current()},[x,I]);let M=async({code:a})=>{let t=await A();await _({slug:e,code:a,hcaptchaToken:t},{onSuccess:e=>{m.setValue("code",""),T()}})};if(!n)return null;let L=!i||!r||d||h;return(0,t.jsxs)(aV.Dialog,{open:x,onOpenChange:e=>{y(e),e||(w(),T())},children:[!a&&(0,t.jsx)(aV.DialogTrigger,{asChild:!0,children:(0,t.jsx)(e_.ButtonTooltip,{type:"default",className:"pointer-events-auto",disabled:L,tooltip:{content:{side:"bottom",text:r&&!i?"You need additional permissions to redeem codes":void 0}},children:"Redeem Code"})}),(0,t.jsxs)(aV.DialogContent,{onInteractOutside:e=>e.preventDefault(),size:"large",children:[(0,t.jsx)(g.default,{ref:f,sitekey:"4ca1fdb9-c9c9-4495-ba50-c85fc0e7ec1f",size:"invisible",onOpen:()=>{void 0!==document&&document.body.classList.add("!pointer-events-auto")},onClose:()=>{void 0!==document&&document.body.classList.remove("!pointer-events-auto")},onVerify:e=>{j.current=e,void 0!==document&&document.body.classList.remove("!pointer-events-auto")},onExpire:()=>{j.current=null}}),N?(0,t.jsxs)("div",{className:"p-8",children:[(0,t.jsx)("div",{className:"text-center flex items-center justify-center",children:(0,t.jsx)(aQ,{className:"h-20 w-20"})}),(0,t.jsx)("div",{className:"text-center",children:(0,t.jsx)("p",{className:"font-bold text-lg mt-2",children:"Credits Redeemed!"})}),(0,t.jsx)(aW.Separator,{className:"my-4"}),(0,t.jsx)("div",{className:"flex w-full justify-center items-center",children:(0,t.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,t.jsx)("h4",{className:"opacity-50",children:"$"}),(0,t.jsx)("h1",{className:"relative text-2xl",children:N.amount_cents/100}),(0,t.jsx)("h4",{className:"opacity-50",children:" credits applied"})]})}),N.credits_expire_at&&(0,t.jsxs)("div",{className:"mt-2 flex items-center justify-center gap-2 text-sm text-muted-foreground bg-muted/50 py-3 px-4 rounded-lg",children:[(0,t.jsx)(aK.Calendar,{className:"h-4 w-4"}),(0,t.jsxs)("span",{children:["Expires on ",new Date(N.credits_expire_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})]})]}),l?.plan.id==="free"&&(0,t.jsxs)("div",{className:"mt-4 space-y-4",children:[(0,t.jsx)(aW.Separator,{}),(0,t.jsx)(q.Button,{className:"w-full",size:"medium",type:"primary",asChild:!0,children:(0,t.jsx)(eO.default,{href:`/org/${l?.slug}/billing?panel=subscriptionPlan`,children:"Upgrade Your Organization"})})]})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(aV.DialogHeader,{children:[(0,t.jsx)(aV.DialogTitle,{children:"Redeem Code"}),(0,t.jsx)(aV.DialogDescription,{className:"space-y-2",children:(0,t.jsx)("p",{className:"prose text-sm",children:"Redeem your credit code to add credits to your organization"})})]}),(0,t.jsx)(aV.DialogSectionSeparator,{}),(0,t.jsx)(eH.Form_Shadcn_,{...m,children:d||h?(0,t.jsxs)("div",{className:"p-6 space-y-4",children:[(0,t.jsx)(Q.ShimmeringLoader,{}),(0,t.jsxs)("div",{className:"flex space-x-4",children:[(0,t.jsx)(Q.ShimmeringLoader,{className:"w-1/2"}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-1/2"})]})]}):(0,t.jsxs)("form",{id:"credit-code-redemption",onSubmit:m.handleSubmit(M),children:[(0,t.jsxs)(aV.DialogSection,{className:"flex flex-col gap-2",children:[(0,t.jsx)(e9.FormField_Shadcn_,{control:m.control,name:"code",render:({field:e})=>(0,t.jsx)(ai.FormItemLayout,{label:"Code",className:"gap-1",children:(0,t.jsx)(ae.Input_Shadcn_,{...e,className:"uppercase",placeholder:"ABCD-1234-EFGH-5678"})})}),p&&p.balance<0&&(0,t.jsxs)("div",{className:"mt-2 flex w-full justify-between items-center",children:[(0,t.jsx)("span",{children:"Current Balance"}),(0,t.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,t.jsx)("h4",{className:"opacity-50",children:"$"}),(0,t.jsx)("h1",{className:"relative",children:-(p.balance/100)}),(0,t.jsx)("h4",{className:"opacity-50",children:"/credits"})]})]}),(0,t.jsxs)(aq.Alert,{variant:"default",className:"mt-4",children:[(0,t.jsx)(a$.AlertCircle,{className:"h-4 w-4"}),(0,t.jsx)(aq.AlertTitle,{children:"Potential future charges"}),(0,t.jsxs)(aq.AlertDescription,{children:["Credits are applied to ",(0,t.jsx)("strong",{children:l?.name})," only and can't be shared or transferred to other organizations. Credits are automatically used toward invoices. When credits run out on a paid plan, your default payment method will be charged—your plan won't be downgraded automatically."]})]}),S&&(0,t.jsxs)(aA.Alert_Shadcn_,{variant:"destructive",children:[(0,t.jsx)(a$.AlertCircle,{className:"h-4 w-4 text-foreground-light"}),(0,t.jsx)(aT.AlertTitle_Shadcn_,{children:"Code cannot be redeemed"}),(0,t.jsx)(aG.AlertDescription_Shadcn_,{children:S?.message})]})]}),(0,t.jsx)(aV.DialogFooter,{children:(0,t.jsx)(q.Button,{htmlType:"submit",type:"primary",loading:v,disabled:L,children:"Redeem"})})]})})]})]})]})};var a0=e.i(831098),a2=e.i(917816);async function a1({payment_method_id:e,amount:a,slug:t,hcaptchaToken:s,address:i,tax_id:r,billing_name:n}){if(!e)throw Error("Payment method id required");if(!s)throw Error("Captcha not submitted");if(!t)throw Error("Slug is required");let{data:l,error:o}=await (0,_.post)("/platform/organizations/{slug}/billing/credits/top-up",{params:{path:{slug:t}},body:{payment_method_id:e,amount:a,hcaptcha_token:s,address:i??void 0,tax_id:r??void 0,billing_name:n??void 0}});return o&&(0,_.handleError)(o),l}var a4=e.i(833655),a3=e.i(585915),a5=e.i(331077);let a8=(0,y.loadStripe)(N.STRIPE_PUBLIC_KEY),a6=(0,s.forwardRef)(function({selectedPaymentMethod:e,onSelectPaymentMethod:a,layout:r="vertical",readOnly:n},l){let{slug:d}=(0,i.useParams)(),{data:c}=(0,o.useSelectedOrganizationQuery)(),[u,m]=(0,s.useState)(null),[y,j]=(0,s.useState)(null),[b,_]=(0,s.useState)(void 0),[v,C]=(0,s.useState)(!0),{resolvedTheme:P}=(0,f.useTheme)(),T=(0,s.useRef)(null),[A,E]=(0,s.useState)(null),{data:I,isPending:M}=k({slug:d}),{data:L,isPending:F}=R({slug:d}),{data:D,isPending:z}=es({slug:d}),O=(0,s.useMemo)(()=>D?{data:I?.address==null?[]:D.data,defaultPaymentMethodId:D.data.some(e=>e.id===D.defaultPaymentMethodId)?D.defaultPaymentMethodId:null}:{data:[],defaultPaymentMethodId:null},[D,I]),U=(0,s.useCallback)(e=>{j(e)},[]),{mutate:B,isPending:q}=S({onSuccess:e=>{_(e)},onError:e=>{h.toast.error(`Failed to setup intent: ${e.message}`)}});(0,s.useEffect)(()=>{O?.data&&0===O.data.length&&null==A&&E(!0)},[O]),(0,s.useEffect)(()=>{let e=async e=>{let a=c?.slug;return a?e?void(_(void 0),B({slug:a,hcaptchaToken:e})):console.error("HCaptcha token required"):console.error("Slug is required")};(async()=>{if(A&&y){let a=u;try{if(!a){let e=await y.execute({async:!0});a=e?.response??null}}catch(e){return}await e(a??void 0),K()}})()},[y,A]);let K=()=>{m(null),y?.resetCaptcha()},Y=(0,s.useMemo)(()=>({clientSecret:b?b.client_secret:"",appearance:(0,G.getStripeElementsAppearanceOptions)(P),paymentMethodCreation:"manual"}),[b,P]);(0,s.useEffect)(()=>{if(O?.data&&O.data.length>0){let t=O.data.some(a=>a.id===e);if(!e||!t){let e=O.data.find(e=>e.is_default);void 0!==e?a(e.id):a(O.data[0].id)}}},[e,O,a]);let V=async()=>{if(!(A||O?.data&&0===O.data.length))return{paymentMethod:{id:e},customerName:v?I?.billing_name||"":null,address:v?I?.address??null:null,taxId:v?L??null:null};{let e=await T.current?.createPaymentMethod();return e?{paymentMethod:e.paymentMethod,customerName:v?e.customerName:null,address:v?e.address:null,taxId:v?e.taxId:null}:e}};return(0,s.useImperativeHandle)(l,()=>({createPaymentMethod:V})),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(g.default,{ref:U,sitekey:"4ca1fdb9-c9c9-4495-ba50-c85fc0e7ec1f",size:"invisible",onOpen:()=>{void 0!==document&&document.body.classList.add("!pointer-events-auto")},onClose:()=>{_(void 0),void 0!==document&&document.body.classList.remove("!pointer-events-auto")},onVerify:e=>{m(e),void 0!==document&&document.body.classList.remove("!pointer-events-auto")},onExpire:()=>{m(null)}}),(0,t.jsxs)("div",{children:[z||M?(0,t.jsxs)("div",{className:"flex items-center px-4 py-2 space-x-4 border rounded-md border-strong bg-surface-200",children:[(0,t.jsx)(a3.Loader,{className:"animate-spin",size:14}),(0,t.jsx)("p",{className:"text-sm text-foreground-light",children:"Retrieving payment methods"})]}):O?.data&&O?.data.length>0&&!A?(0,t.jsxs)(a5.Listbox,{layout:r,label:"Payment method",value:e,onChange:a,className:"flex items-center",children:[O?.data.map(e=>{let a=`•••• •••• •••• ${e.card.last4}`;return(0,t.jsx)(a5.Listbox.Option,{label:a,value:e.id,addOnBefore:()=>(0,t.jsx)("img",{alt:"Credit Card Brand",src:`${N.BASE_PATH}/img/payment-methods/${e.card.brand.replace(" ","-").toLowerCase()}.png`,width:"32"}),children:(0,t.jsx)("div",{children:a})},e.id)}),(0,t.jsxs)("div",{className:"flex items-center px-3 py-2 space-x-2 transition cursor-pointer group hover:bg-surface-300",onClick:()=>{E(!0)},children:[(0,t.jsx)(p.Plus,{size:16}),(0,t.jsx)("p",{className:"transition text-foreground-light group-hover:text-foreground",children:"Add new payment method"})]})]}):null,a8&&b&&I&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(x.Elements,{stripe:a8,options:Y,children:(0,t.jsx)(w.NewPaymentMethodElement,{ref:T,email:c?.billing_email??void 0,readOnly:n,customerName:I?.billing_name,currentAddress:I?.address,currentTaxId:L})}),I?.address!=null&&(0,t.jsxs)("div",{className:"flex items-center space-x-2 mt-4",children:[(0,t.jsx)($.Checkbox_Shadcn_,{id:"defaultBillingAddress",checked:v,onCheckedChange:()=>C(!v)}),(0,t.jsx)("label",{htmlFor:"defaultBillingAddress",className:"text-sm leading-none text-foreground-light",children:"Use address as my org's billing address"})]})]}),(q||M||F)&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(Q.ShimmeringLoader,{className:"h-10"}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,t.jsx)(Q.ShimmeringLoader,{className:"h-10"}),(0,t.jsx)(Q.ShimmeringLoader,{className:"h-10"})]}),(0,t.jsx)(Q.ShimmeringLoader,{className:"h-10"})]})]})]})});a6.displayName="PaymentMethodSelection";let a9=(0,y.loadStripe)(N.STRIPE_PUBLIC_KEY),a7=e0.z.object({amount:e0.z.coerce.number().gte(100,"Amount must be between $100 - $2000.").lte(2e3,"Amount must be between $100 - $2000.").int("Amount must be a whole number."),paymentMethod:e0.z.string()}),te=({slug:e})=>{let{resolvedTheme:a}=(0,f.useTheme)(),i=(0,C.useQueryClient)(),r=(0,s.useRef)(null),{can:n,isSuccess:l}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.BILLING_WRITE,"stripe.subscriptions"),{mutateAsync:o,isPending:d,error:u}=(({onSuccess:e,onError:a,...t}={})=>(0,b.useMutation)({mutationFn:e=>a1(e),async onSuccess(a,t,s){await e?.(a,t,s)},async onError(e,t,s){void 0===a?h.toast.error(`Failed to top up credits: ${e.message}`):a(e,t,s)},...t}))({}),m=(0,ac.useForm)({resolver:(0,ad.zodResolver)(a7),defaultValues:{amount:100,paymentMethod:""}}),[p,y]=(0,s.useState)(!1),[j,_]=(0,s.useState)(!1),[v,S]=(0,s.useState)(null),[N,w]=(0,s.useState)(null),P=(0,s.useCallback)(e=>{w(e)},[]),T=async()=>{if(p&&N){let e=v;try{if(!e){let a=await N.execute({async:!0});e=a?.response??null,S(e)}}catch(e){}return e}};(0,s.useEffect)(()=>{T()},[p,N]);let[A,I]=(0,s.useState)(""),[k,M]=(0,s.useState)(),L=async({amount:a,paymentMethod:t})=>{M(void 0);let s=await T(),i=await r.current?.createPaymentMethod();i&&await o({slug:e,amount:a,payment_method_id:i.paymentMethod.id,hcaptchaToken:s,address:i.address,tax_id:i.taxId??void 0,billing_name:i.customerName},{onSuccess:e=>{"succeeded"===e.status?z():I(e.payment_intent_secret||""),S(null),N?.resetCaptcha()}})},F=(0,s.useMemo)(()=>({clientSecret:A,appearance:(0,G.getStripeElementsAppearanceOptions)(a)}),[A,a]),D=e=>{y(e),e||(w(null),M(void 0),I(""))},z=async()=>{D(!1),await i.invalidateQueries({queryKey:aM.subscriptionKeys.orgSubscription(e)}),h.toast.success("Successfully topped up balance. It may take a minute to reflect in your account.")};return(0,t.jsxs)(aV.Dialog,{open:p,onOpenChange:e=>D(e),children:[(0,t.jsx)(aV.DialogTrigger,{asChild:!0,children:(0,t.jsx)(e_.ButtonTooltip,{type:"default",className:"pointer-events-auto",disabled:!n||!l,tooltip:{content:{side:"bottom",text:l&&!n?"You need additional permissions to top up credits":void 0}},children:"Top Up"})}),(0,t.jsxs)(aV.DialogContent,{onInteractOutside:e=>e.preventDefault(),children:[(0,t.jsx)(g.default,{ref:P,sitekey:"4ca1fdb9-c9c9-4495-ba50-c85fc0e7ec1f",size:"invisible",onOpen:()=>{void 0!==document&&document.body.classList.add("!pointer-events-auto")},onClose:()=>{void 0!==document&&document.body.classList.remove("!pointer-events-auto")},onVerify:e=>{S(e),void 0!==document&&document.body.classList.remove("!pointer-events-auto")},onExpire:()=>{S(null)}}),(0,t.jsxs)(aV.DialogHeader,{children:[(0,t.jsx)(aV.DialogTitle,{children:"Top Up Credits"}),(0,t.jsxs)(aV.DialogDescription,{className:"space-y-2",children:[(0,t.jsx)("p",{className:"prose text-sm",children:"On successful payment, an invoice will be issued and you'll be granted credits. Credits will be applied to future invoices only and are not refundable. The topped up credits do not expire."}),(0,t.jsxs)("p",{className:"prose text-sm",children:["For larger discounted credit packages, please reach out to us via"," ",(0,t.jsx)(H.SupportLink,{queryParams:{orgSlug:e,projectRef:a2.NO_PROJECT_MARKER,subject:"I would like to inquire about larger credit packages",category:c.SupportCategories.SALES_ENQUIRY},children:"support"}),"."]})]})]}),(0,t.jsx)(aV.DialogSectionSeparator,{}),(0,t.jsx)(eH.Form_Shadcn_,{...m,children:(0,t.jsxs)("form",{id:"credit-top-up",onSubmit:m.handleSubmit(L),children:[(0,t.jsxs)(aV.DialogSection,{className:"flex flex-col gap-2",children:[(0,t.jsx)(e9.FormField_Shadcn_,{control:m.control,name:"amount",render:({field:e})=>(0,t.jsx)(ai.FormItemLayout,{label:"Amount (USD)",className:"gap-1",children:(0,t.jsx)(ae.Input_Shadcn_,{...e,type:"number",placeholder:"100"})})}),(0,t.jsx)(e9.FormField_Shadcn_,{control:m.control,name:"paymentMethod",render:()=>(0,t.jsx)(a6,{ref:r,onSelectPaymentMethod:e=>m.setValue("paymentMethod",e),selectedPaymentMethod:m.getValues("paymentMethod"),readOnly:d||j})}),k&&k.error&&(0,t.jsxs)(aA.Alert_Shadcn_,{variant:"destructive",children:[(0,t.jsx)(a$.AlertCircle,{className:"h-4 w-4"}),(0,t.jsx)(aT.AlertTitle_Shadcn_,{children:"Error confirming payment"}),(0,t.jsx)(aG.AlertDescription_Shadcn_,{children:k.error.message})]}),k?.paymentIntent&&"processing"===k.paymentIntent.status&&(0,t.jsxs)(aA.Alert_Shadcn_,{variant:"default",children:[(0,t.jsx)(a4.Info,{className:"h-4 w-4"}),(0,t.jsx)(aT.AlertTitle_Shadcn_,{children:"Payment processing"}),(0,t.jsx)(aG.AlertDescription_Shadcn_,{children:"Your payment is processing and we are waiting for a confirmation from your card issuer. If the payment goes through you'll automatically be credited. Please check back later."})]}),u&&(0,t.jsxs)(aA.Alert_Shadcn_,{variant:"destructive",children:[(0,t.jsx)(a$.AlertCircle,{className:"h-4 w-4"}),(0,t.jsx)(aT.AlertTitle_Shadcn_,{children:"Error topping up balance"}),(0,t.jsx)(aG.AlertDescription_Shadcn_,{children:u.message})]})]}),!k?.paymentIntent&&(0,t.jsx)(aV.DialogFooter,{children:(0,t.jsx)(q.Button,{htmlType:"submit",type:"primary",loading:d||j,children:"Top Up"})})]})}),a9&&A&&(0,t.jsx)(x.Elements,{stripe:a9,options:F,children:(0,t.jsx)(a0.PaymentConfirmation,{paymentIntentSecret:A,onPaymentIntentConfirm:e=>{I(""),M(e),e.paymentIntent?.status==="succeeded"&&z()},onLoadingChange:e=>_(e)})})]})]})},ta=()=>{let{slug:e}=(0,i.useParams)(),{isSuccess:a,can:s}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.BILLING_READ,"stripe.subscriptions"),{data:l,error:o,isPending:d,isError:u,isSuccess:m}=(0,n.useOrgSubscriptionQuery)({orgSlug:e},{enabled:s}),p=(l?.customer_balance??0)/100,h=p<0,g=p>0,x=h&&0!==p?p.toFixed(2).toString().replace("-",""):p.toFixed(2);return(0,t.jsxs)(r.ScaffoldSection,{children:[(0,t.jsx)(r.ScaffoldSectionDetail,{children:(0,t.jsxs)("div",{className:"sticky space-y-2 top-12 pr-3",children:[(0,t.jsx)("div",{className:"flex items-center space-x-2",children:(0,t.jsx)("p",{className:"text-foreground text-base m-0",children:"Credit Balance"})}),(0,t.jsx)("p",{className:"text-sm text-foreground-light m-0",children:"Credits will be applied to future invoices, before charging your payment method. If your credit balance runs out, your default payment method will be charged."})]})}),(0,t.jsx)(r.ScaffoldSectionContent,{children:a&&!s?(0,t.jsx)(ee.default,{resourceText:"view this organization's credits"}):(0,t.jsx)(J.FormPanel,{footer:l?.billing_via_partner?void 0:(0,t.jsxs)("div",{className:"flex justify-end items-center py-4 px-8 gap-x-2",children:[(0,t.jsx)(aZ,{slug:e}),(0,t.jsx)(te,{slug:e})]}),children:(0,t.jsx)(Z.FormSection,{children:(0,t.jsxs)(Z.FormSectionContent,{fullWidth:!0,loading:d,children:[u&&(0,t.jsx)(X.default,{subject:"Failed to retrieve organization customer profile",error:o}),m&&(0,t.jsxs)("div",{className:"flex w-full justify-between items-center",children:[(0,t.jsx)("span",{children:"Balance"}),(0,t.jsxs)("div",{className:"flex items-center space-x-1",children:[g&&(0,t.jsx)("h4",{className:"opacity-50",children:"-"}),(0,t.jsx)("h4",{className:"opacity-50",children:"$"}),(0,t.jsx)("h1",{className:"relative",children:x}),h&&(0,t.jsx)("h4",{className:"opacity-50",children:"/credits"})]})]})]})})})})]})};var tt=e.i(286260),ts=e.i(413850),ti=e.i(743371),tr=e.i(781894),tn=e.i(31563);async function tl({organizationSlug:e,tier:a}){if(!e)throw Error("organizationSlug is required");if(!a)throw Error("tier is required");let{data:t,error:s}=await (0,_.post)("/platform/organizations/{slug}/billing/subscription/preview",{params:{path:{slug:e}},body:{tier:a},headers:{Version:"2"}});return s&&(0,_.handleError)(s),t}async function to({slug:e},a){if(!e)throw Error("Organization slug is required");let{data:t,error:s}=await (0,_.get)("/platform/organizations/{slug}",{params:{path:{slug:e}},signal:a});return s&&(0,_.handleError)(s),{...t,billing_email:t.billing_email??"Unknown",managed_by:t.slug.startsWith("vercel_icfg_")?"vercel-marketplace":"supabase",partner_id:t.slug.startsWith("vercel_")?t.slug.replace("vercel_",""):void 0}}var td=e.i(722740);async function tc({orgSlug:e},a){if(!e)throw Error("orgSlug is required");let{error:t,data:s}=await (0,_.get)("/platform/organizations/{slug}/billing/plans",{params:{path:{slug:e}},signal:a});return t&&(0,_.handleError)(t),s}var tu=e.i(162082),tm=e.i(301419),tp=e.i(591862),th=e.i(1606);let tg=({projectAddon:e})=>{let a=e.addons.find(e=>"compute_instance"===e.type),s=e.addons.filter(e=>!["log_drain","auth_mfa_phone"].includes(e.type)).map(e=>"compute_instance"===e.type?`${e.variant.name} Compute Instance`:e.variant.name);return(0,t.jsxs)("li",{className:"list-disc ml-6",children:[e.name,": ",s.join(", ")," will be removed.",a?(0,t.jsxs)(t.Fragment,{children:[" ","Project will also ",(0,t.jsx)("span",{className:"font-bold",children:"need to be restarted"})," due to change in compute instance"]}):""]})},tx=({visible:e,subscription:a,onClose:i,onConfirm:r,projects:n})=>{let l=(0,s.useMemo)(()=>tm.plans.find(e=>"tier_free"===e.id),[]),o=a?.project_addons.flatMap(e=>{let a=e.addons.filter(e=>"ci_micro"!==e.variant.identifier);return a.length?{...e,addons:a}:[]})||[],d=n.some(e=>"micro"===(0,td.getComputeSize)(e));return(0,t.jsx)(j.Modal,{size:"large",alignFooter:"right",variant:"warning",visible:e,onCancel:i,onConfirm:r,header:`Confirm to downgrade to ${l?.name} plan`,children:(0,t.jsxs)(j.Modal.Content,{children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(en.Admonition,{type:"warning",title:"Downgrading to the Free Plan will lead to reductions in your organization's quota",description:"If you're already past the limits of the Free Plan, your projects could become unresponsive or enter read only mode."}),((o.length??0)>0||d)&&(0,t.jsx)(en.Admonition,{type:"warning",title:"Projects affected by the downgrade",children:(0,t.jsxs)("ul",{className:"space-y-1 max-h-[100px] overflow-y-auto",children:[o.map(e=>(0,t.jsx)(tg,{projectAddon:e},e.ref)),n.filter(e=>"micro"===(0,td.getComputeSize)(e)).map(e=>(0,t.jsxs)("li",{className:"list-disc ml-6",children:[e.name,": Compute will be downgraded. Project will also"," ",(0,t.jsx)("span",{className:"font-bold",children:"need to be restarted"}),"."]},e.ref))]})})]}),(0,t.jsxs)("ul",{className:"mt-4 space-y-5 text-sm",children:[(0,t.jsxs)("li",{className:"flex items-center gap-3",children:[(0,t.jsx)(th.PauseCircle,{size:18}),(0,t.jsx)("span",{children:"Projects will be paused after a week of inactivity"})]}),(0,t.jsxs)("li",{className:"flex items-center gap-3 mb-2",children:[(0,t.jsx)(tp.MinusCircle,{size:18}),(0,t.jsx)("span",{children:"Add ons from all projects under this organization will be removed."})]}),(0,t.jsx)("li",{className:"flex gap-3",children:(0,t.jsxs)("div",{children:[(0,t.jsxs)("strong",{children:["Before you downgrade to the ",l?.name," plan, consider:"]}),(0,t.jsxs)("ul",{className:"space-y-2 mt-2",children:[(0,t.jsx)("li",{className:"list-disc ml-6 text-foreground-light",children:"Your projects no longer require their respective add-ons."}),(0,t.jsxs)("li",{className:"list-disc ml-6 text-foreground-light",children:["Your resource consumption are well within the ",l?.name," plan's quota."]}),(0,t.jsx)("li",{className:"list-disc ml-6 text-foreground-light",children:"Alternatively, you may also transfer projects across organizations."})]})]})})]}),a?.billing_via_partner===!0&&"fly"===a.billing_partner&&(0,t.jsx)("p",{className:"mt-4 text-sm",children:"Your organization will be downgraded at the end of your current billing cycle."})]})})},ty=({plan:e,isCurrentPlan:a})=>{let{data:s}=(0,o.useSelectedOrganizationQuery)(),i=s?.slug,r=e.features,n=s?.plan.name,{mutate:l}=(0,tu.useSendEventMutation)();return(0,t.jsxs)("div",{className:(0,d.cn)("grid grid-cols-1 md:grid-cols-3 border rounded-md bg-studio","py-4 col-span-12 justify-between gap-x-8"),children:[(0,t.jsxs)("div",{className:"flex flex-col justify-center px-4",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)("p",{className:(0,d.cn)("text-brand text-sm uppercase"),children:e.name}),a?(0,t.jsx)("div",{className:"text-xs bg-surface-300 text-foreground-light rounded px-2 py-0.5",children:"Current plan"}):e.nameBadge?(0,t.jsx)("div",{className:"text-xs bg-surface-200 text-brand rounded px-2 py-0.5",children:e.nameBadge}):null]}),(0,t.jsx)("p",{className:"text-sm mt-2 mb-4",children:e.description}),(0,t.jsx)(q.Button,{block:!0,asChild:!0,type:"default",size:"tiny",onClick:()=>l({action:"studio_pricing_plan_cta_clicked",properties:{selectedPlan:"Enterprise",currentPlan:n},groups:{organization:i??"Unknown"}}),children:(0,t.jsx)("a",{href:e.href,className:"hidden md:block",target:"_blank",children:e.cta})})]}),(0,t.jsxs)("div",{className:"flex flex-col justify-center col-span-2 px-4 md:px-0",children:[(0,t.jsx)("ul",{role:"list",className:"text-xs text-foreground-light md:grid md:grid-cols-2 md:gap-x-10",children:r.map(e=>(0,t.jsxs)("li",{className:"flex items-center py-2 first:mt-0",children:[(0,t.jsx)(eX.Check,{className:"text-brand h-4 w-4","aria-hidden":"true",strokeWidth:3}),(0,t.jsx)("span",{className:"text-foreground mb-0 ml-3 ",children:"string"==typeof e?e:e[0]})]},"string"==typeof e?e:e[0]))}),(0,t.jsx)(q.Button,{block:!0,asChild:!0,type:"default",size:"tiny",onClick:()=>l({action:"studio_pricing_plan_cta_clicked",properties:{selectedPlan:"Enterprise",currentPlan:n},groups:{organization:i??"Unknown"}}),children:(0,t.jsx)("a",{href:e.href,className:"visible md:hidden mt-8",target:"_blank",children:e.cta})})]})]},e.id)};var tf=e.i(776578),tj=e.i(981682),tb=e.i(171997);let t_=({visible:e,projects:a,onClose:r})=>{var n;let l,{slug:o}=(0,i.useParams)(),[c,u]=(0,s.useState)(""),[m,p]=(0,s.useState)([]),g=(0,a_.useFlag)("disableProjectCreationAndUpdate"),{mutate:x,isPending:y}=aF({onError:e=>{h.toast.error(`Failed to downgrade project: ${e.message}`)}}),{mutateAsync:f,isPending:b}=(0,tj.useSendDowngradeFeedbackMutation)(),_=y||b,v=a.filter(e=>"nano"!==(0,td.getComputeSize)(e)),S=v.length>0,[N]=(0,s.useState)(()=>[...tf.CANCELLATION_REASONS.sort(()=>Math.random()-.5),{value:"None of the above"}]),C=(n=m[0],l=tf.CANCELLATION_REASONS.find(e=>e.value===n),l?.label||"What can we improve on?"),w=async()=>{if(0===m.length)return h.toast.error("Please select a reason for canceling your subscription");await P()},P=async()=>{if(!o)return console.error("Slug is required");x({slug:o,tier:"tier_free"},{onSuccess:async()=>{try{await f({orgSlug:o,reasons:m.reduce((e,a)=>`${e}- ${a}
`,""),message:c,exitAction:"downgrade"})}catch(e){}finally{h.toast.success(S?"Successfully downgraded organization to the Free Plan. Your projects are currently restarting to update their compute instances.":"Successfully downgraded organization to the Free Plan",{duration:S?8e3:4e3}),r(!0),window.scrollTo({top:0,left:0,behavior:"smooth"})}}})};return(0,t.jsxs)(j.Modal,{hideFooter:!0,size:"xlarge",visible:e,onCancel:r,header:"Help us improve",children:[(0,t.jsx)(j.Modal.Content,{children:(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsx)("p",{className:"text-sm text-foreground-light",children:"Share with us why you're downgrading your plan."}),(0,t.jsxs)("div",{className:"space-y-8 mt-6",children:[(0,t.jsx)("div",{className:"flex flex-wrap gap-2","data-toggle":"buttons",children:N.map(e=>{let a=m[0]===e.value;return(0,t.jsxs)("label",{className:(0,d.cn)("flex cursor-pointer items-center space-x-2 rounded-md py-1","pl-2 pr-3 text-center text-sm","shadow-sm transition-all duration-100",a?"bg-foreground text-background opacity-100 hover:bg-opacity-75":"bg-border-strong text-foreground opacity-75 hover:opacity-100"),children:[(0,t.jsx)("input",{type:"radio",name:"options",value:e.value,className:"hidden",checked:a,onChange:()=>{p([e.value])}}),(0,t.jsx)("div",{children:e.value})]},e.value)})}),(0,t.jsxs)("div",{className:"text-area-text-sm flex flex-col gap-y-2",children:[(0,t.jsx)("label",{className:"text-sm whitespace-pre-line break-words",children:C}),(0,t.jsx)(tb.Input.TextArea,{id:"message",name:"message",value:c,onChange:e=>u(e.target.value),rows:3})]})]}),S&&(0,t.jsxs)(aP.Alert,{withIcon:!0,variant:"warning",title:`${v.length} of your projects will be restarted upon clicking confirm,`,children:["This is due to changes in compute instances from the downgrade. Affected projects include ",v.map(e=>e.name).join(", "),"."]})]})}),(0,t.jsxs)("div",{className:"flex items-center justify-between border-t px-4 py-4",children:[(0,t.jsx)("p",{className:"text-xs text-foreground-lighter",children:"The unused amount for the remaining time of your billing cycle will be refunded as credits"}),(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(q.Button,{type:"default",onClick:()=>r(),children:"Cancel"}),(0,t.jsx)(aE.default,{projectUpdateDisabled:g,children:(0,t.jsx)(q.Button,{type:"danger",className:"pointer-events-auto",loading:_,disabled:g||_,onClick:w,children:"Confirm downgrade"})})]})]})]})},tv=({visible:e,onClose:a})=>{let{data:s}=(0,o.useSelectedOrganizationQuery)(),i=s?.slug,{data:r}=(0,tn.useFreeProjectLimitCheckQuery)({slug:i},{enabled:e});return(0,t.jsxs)(j.Modal,{hideFooter:!0,visible:e,size:"medium",header:"Your organization has members who have exceeded their free project limits",onCancel:a,children:[(0,t.jsx)(j.Modal.Content,{children:(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("p",{className:"text-sm text-foreground-light",children:"The following members have reached their maximum limits for the number of active free plan projects within organizations where they are an administrator or owner:"}),(0,t.jsx)("ul",{className:"pl-5 text-sm list-disc text-foreground-light",children:(r||[]).map((e,a)=>(0,t.jsxs)("li",{children:[e.username||e.primary_email," (Limit: ",e.free_project_limit," free projects)"]},`member-${a}`))}),(0,t.jsx)("p",{className:"text-sm text-foreground-light",children:"These members will need to either delete, pause, or upgrade one or more of these projects before you're able to downgrade this project."})]})}),(0,t.jsx)(j.Modal.Separator,{}),(0,t.jsx)(j.Modal.Content,{className:"flex items-center gap-2",children:(0,t.jsx)(q.Button,{htmlType:"button",type:"default",onClick:a,block:!0,children:"Understood"})})]})};var tS=e.i(870152);async function tN({payment_intent_id:e,slug:a}){if(!a)throw Error("Organization slug is required to confirm pending subscription change");let{data:t,error:s}=await (0,_.post)("/platform/organizations/{slug}/billing/subscription/confirm",{params:{path:{slug:a}},body:{payment_intent_id:e}});return s&&(0,_.handleError)(s),t}let tC=(0,y.loadStripe)(N.STRIPE_PUBLIC_KEY),tw={tier_pro:"the Pro plan to unlock more compute resources, daily backups, no project pausing, and email support whenever you need it",tier_team:"the Team plan for SOC2, SSO, priority support and greater data and log retention",default:"to a new plan"},tP={tier_free:"the Free plan with limited resources and active projects",tier_pro:"the Pro plan",default:"to a lower plan"},tT=({selectedTier:e,onClose:a,planMeta:i,subscriptionPreviewError:r,subscriptionPreviewIsLoading:n,subscriptionPreviewInitialized:l,subscriptionPreview:d,subscription:c,currentPlanMeta:u,projects:m})=>{let p,g,y,j,_,{resolvedTheme:v}=(0,f.useTheme)(),{data:S}=(0,o.useSelectedOrganizationQuery)(),[w,T]=(0,s.useState)(),[A,E]=(0,s.useState)(null),[I,k]=(0,s.useState)(!1),M=(0,s.useRef)(null),L=c?.billing_via_partner===!0,F=c?.billing_partner,D=(0,s.useMemo)(()=>({clientSecret:A,appearance:(0,G.getStripeElementsAppearanceOptions)(v)}),[A,v]),z=(0,s.useMemo)(()=>(0,ti.getPlanChangeType)(c?.plan?.id,i?.id),[i,c]),R=(0,s.useMemo)(()=>tm.plans.find(a=>a.id===e),[e]),O=()=>{k(!1),h.toast.success(`Successfully ${"downgrade"===z?"downgraded":"upgraded"} subscription to ${R?.name}!`),a(),window.scrollTo({top:0,left:0,behavior:"smooth"})},{mutate:U,isPending:B}=aF({onSuccess:e=>{e.pending_payment_intent_secret?E(e.pending_payment_intent_secret):O()},onError:e=>{k(!1),h.toast.error(`Unable to update subscription: ${e.message}`)}}),{mutate:$,isPending:K}=(({onSuccess:e,onError:a,...t}={})=>{let s=(0,C.useQueryClient)();return(0,b.useMutation)({mutationFn:e=>tN(e),async onSuccess(a,t,i){let{slug:r}=t;a&&"message"in a?h.toast.success(a.message,{dismissible:!0,duration:1e4}):(await new Promise(e=>setTimeout(e,2e3)),await Promise.all([s.invalidateQueries({queryKey:aM.subscriptionKeys.orgSubscription(r)}),s.invalidateQueries({queryKey:aM.subscriptionKeys.orgPlans(r)}),s.invalidateQueries({queryKey:ak.usageKeys.orgUsage(r)}),s.invalidateQueries({queryKey:ev.invoicesKeys.orgUpcomingPreview(r)}),s.invalidateQueries({queryKey:P.organizationKeys.detail(r)}),s.invalidateQueries({queryKey:P.organizationKeys.list()}),s.invalidateQueries({queryKey:P.organizationKeys.paymentMethods(r)})]),await e?.(a,t,i))},async onError(e,t,s){void 0===a?h.toast.error(e.message,{dismissible:!0,duration:1e4}):a(e,t,s)},...t})})({onSuccess:()=>{O()},onError:e=>{h.toast.error(`Unable to update subscription: ${e.message}`)}}),Y=async e=>{E(""),e.paymentIntent?.status==="succeeded"?await $({slug:S?.slug,payment_intent_id:e.paymentIntent.id}):(k(!1),h.toast.error("Could not confirm payment. Please try again or use a different card."))},V=async()=>{if(!S?.slug)return console.error("org slug is required");if(!e)return console.error("Selected plan is required");k(!0);let a=await M.current?.createPaymentMethod();if(a?T(a.paymentMethod.id):k(!1),!a&&c?.payment_method_type!=="invoice"&&"upgrade"===z)return;let t=c?.plan?.id==="team"&&e===ei.PRICING_TIER_PRODUCT_IDS.PRO?ei.PRICING_TIER_PRODUCT_IDS.PAYG:e;U({slug:S?.slug,tier:t,paymentMethod:a?.paymentMethod?.id,address:a?.address,tax_id:a?.taxId??void 0,billing_name:a?.customerName??void 0})},W=R?.features||[],H=u?.features||[],J="downgrade"===z?H.filter(e=>{let a="string"==typeof e?e:e[0];return!W.some(e=>("string"==typeof e?e:e[0])===a)}):[],Z=Math.floor(Date.now()/1e3),ee=c?.current_period_end-Z,ea=c?.current_period_end-c?.current_period_start,et=(u?.price??0)*(ee/ea),es=Number(R?.priceMonthly)??0,el=-((c?.customer_balance??0)/100*1),eo=Math.max(0,es-et-el);return(0,t.jsx)(aV.Dialog,{open:void 0!==e&&"tier_free"!==e,onOpenChange:e=>{B||I||K||e||a()},children:(0,t.jsxs)(aV.DialogContent,{onOpenAutoFocus:e=>e.preventDefault(),size:"xlarge",className:"p-0",children:[(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 h-full items-stretch",children:[(0,t.jsxs)("div",{className:"p-8 pb-8 flex flex-col xl:col-span-3",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsxs)("div",{children:[!L&&null!=d&&"upgrade"===z&&(0,t.jsx)("div",{className:"space-y-2 mb-4",children:(0,t.jsx)(a6,{ref:M,selectedPaymentMethod:w,onSelectPaymentMethod:e=>T(e),readOnly:I||K||B})}),L&&(0,t.jsxs)("div",{className:"mb-4",children:[(0,t.jsxs)("p",{className:"text-sm",children:["This organization is billed through our partner"," ",(0,ti.billingPartnerLabel)(F),"."," ","aws"===F?(0,t.jsx)(t.Fragment,{children:"The organization's credit balance will be decreased accordingly."}):(0,t.jsx)(t.Fragment,{children:"You will be charged by them directly."})]}),L&&"fly"===F&&d?.plan_change_type==="downgrade"&&(0,t.jsx)("p",{className:"text-sm",children:"Your organization will be downgraded at the end of your current billing cycle."})]})]}),n&&(0,t.jsxs)("div",{className:"space-y-2 mb-4 mt-2",children:[(0,t.jsx)(Q.ShimmeringLoader,{}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-3/4"}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-1/2"})]}),l&&(0,t.jsx)(t.Fragment,{children:(0,t.jsxs)("div",{className:"mt-2 mb-4 text-foreground-light text-sm",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between gap-2 border-b border-muted text-foreground",children:[(0,t.jsx)("div",{className:"py-2 pl-0",children:"Charge today"}),(0,t.jsxs)("div",{className:"py-2 pr-0 text-right",translate:"no",children:[(0,er.formatCurrency)(eo),c?.plan?.id!=="free"&&(0,t.jsxs)(t.Fragment,{children:[" ",(0,t.jsx)(eO.default,{href:`/org/${S?.slug}/billing#breakdown`,className:"text-sm text-brand hover:text-brand-600 transition",target:"_blank",children:"+ current spend"})]})]})]}),c?.plan?.id!=="free"&&(0,t.jsxs)("div",{className:"flex items-center justify-between gap-2 border-b border-muted text-xs",children:[(0,t.jsxs)("div",{className:"py-2 pl-0 flex items-center gap-1",children:[(0,t.jsxs)("span",{children:["Unused Time on ",c?.plan?.name," Plan"]}),(0,t.jsx)(e$.InfoTooltip,{className:"max-w-sm",children:"Your previous plan was charged upfront, so a plan change will prorate any unused time in credits. If the prorated credits exceed the new plan charge, the excessive credits are added to your organization for future use."})]}),(0,t.jsxs)("div",{className:"py-2 pr-0 text-right",translate:"no",children:["-",(0,er.formatCurrency)(et)]})]}),el>0&&(0,t.jsxs)("div",{className:"flex items-center justify-between gap-2 border-b border-muted text-xs",children:[(0,t.jsxs)("div",{className:"py-2 pl-0 flex items-center gap-1",children:[(0,t.jsx)("span",{children:"Credits"}),(0,t.jsx)(e$.InfoTooltip,{children:"Credits will be used first before charging your card."})]}),(0,t.jsx)("div",{className:"py-2 pr-0 text-right",translate:"no",children:(0,er.formatCurrency)(el)})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between gap-2 text-foreground-lighter text-xs",children:[(0,t.jsxs)("div",{className:"py-2 pl-0 flex items-center gap-1",children:[(0,t.jsx)("span",{children:"Monthly invoice estimate"}),(0,t.jsx)(e$.InfoTooltip,{side:"right",children:(0,t.jsxs)("div",{className:"w-[520px] p-6",children:[(0,t.jsx)("h3",{className:"font-medium mb-2",children:"Your new monthly invoice"}),(0,t.jsxs)("p",{className:"prose text-xs mb-2",children:["First project included. Additional projects cost"," ",(0,t.jsx)("span",{translate:"no",children:"$10"}),"+/month regardless of activity."," ",(0,t.jsx)(eO.default,{href:`${N.DOCS_URL}/guides/platform/manage-your-usage/compute`,target:"_blank",children:"Learn more"}),"."]}),r&&(0,t.jsx)(X.default,{error:r,subject:"Failed to preview subscription."}),n&&(0,t.jsxs)("div",{className:"space-y-2 p-6",children:[(0,t.jsx)("span",{className:"text-sm",children:"Estimating monthly costs..."}),(0,t.jsx)(Q.ShimmeringLoader,{}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-3/4"}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-1/2"})]}),l&&(0,t.jsx)(t.Fragment,{children:(0,t.jsx)(eL.Table,{className:"[&_tr:last-child]:border-t font-mono text-xs",children:(0,t.jsxs)(eL.TableBody,{children:[(p=d?.breakdown?.filter(e=>e.description?.toLowerCase().includes("compute")&&e.breakdown&&e.breakdown.length>0)||[],g=d?.breakdown?.find(e=>e.description.startsWith("Compute Credits"))??null,y=d?.breakdown?.find(e=>e.description?.toLowerCase().includes("plan")),j=p.flatMap(e=>(e.breakdown||[]).map(a=>({...a,computeType:e.description,computeCosts:Math.round(e.total_price/e.breakdown.length)}))),_=d?.breakdown?.filter(e=>!e.description?.toLowerCase().includes("compute")&&!e.description?.toLowerCase().includes("plan"))||[],(0,t.jsxs)(t.Fragment,{children:[j.length>0&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(eL.TableRow,{className:"text-foreground-light",children:[(0,t.jsx)(eL.TableCell,{className:"!py-2 px-0",children:y?.description}),(0,t.jsx)(eL.TableCell,{className:"text-right py-2 px-0",translate:"no",children:(0,er.formatCurrency)(y?.total_price)})]}),(0,t.jsxs)(eL.TableRow,{className:"text-foreground-light",children:[(0,t.jsx)(eL.TableCell,{className:"!py-2 px-0 flex items-center gap-1",children:(0,t.jsx)("span",{children:"Compute"})}),(0,t.jsx)(eL.TableCell,{className:"text-right py-2 px-0",translate:"no",children:(0,er.formatCurrency)(p.reduce((e,a)=>e+a.total_price,0)+(g?.total_price??0))})]}),j.map(e=>(0,t.jsx)(eL.TableRow,{className:"text-foreground-light",children:(0,t.jsxs)(eL.TableCell,{className:"!py-2 px-0 pl-6",translate:"no",children:[e.project_name," (",e.computeType,") |"," ",(0,er.formatCurrency)(e.computeCosts)]})},e.project_ref)),g&&(0,t.jsx)(eL.TableRow,{className:"text-foreground-light",children:(0,t.jsxs)(eL.TableCell,{className:"!py-2 px-0 pl-6",translate:"no",children:["Compute Credits |"," ",(0,er.formatCurrency)(g.total_price)]})})]}),_.map(e=>(0,t.jsxs)(eL.TableRow,{className:"text-foreground-light",children:[(0,t.jsx)(eL.TableCell,{className:"text-xs py-2 px-0",children:(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)("span",{children:e.description??"Unknown"}),e.breakdown&&e.breakdown.length>0&&(0,t.jsxs)(e$.InfoTooltip,{className:"max-w-sm",children:[(0,t.jsxs)("p",{children:["Projects using ",e.description,":"]}),(0,t.jsx)("ul",{className:"ml-6 list-disc",children:e.breakdown.map(a=>(0,t.jsx)("li",{children:a.project_name},`${e.description}-breakdown-${a.project_ref}`))})]})]})}),(0,t.jsx)(eL.TableCell,{className:"text-right text-xs py-2 px-0",translate:"no",children:(0,er.formatCurrency)(e.total_price)})]},e.description))]})),(0,t.jsxs)(eL.TableRow,{children:[(0,t.jsx)(eL.TableCell,{className:"font-medium py-2 px-0",children:"Total per month (excluding other usage)"}),(0,t.jsx)(eL.TableCell,{className:"text-right font-medium py-2 px-0",translate:"no",children:(0,er.formatCurrency)(Math.round(d?.breakdown?.reduce((e,a)=>e+a.total_price,0)??0)??0)})]})]})})})]})})]}),(0,t.jsx)("div",{className:"py-2 pr-0 text-right",translate:"no",children:(0,er.formatCurrency)(Math.round(d?.breakdown.reduce((e,a)=>e+a.total_price,0)??0))})]})]})})]}),(0,t.jsxs)("div",{className:"pt-4",children:[5===m.filter(e=>e.status===ei.PROJECT_STATUS.ACTIVE_HEALTHY||e.status===ei.PROJECT_STATUS.COMING_UP).length&&d?.plan_change_type!=="downgrade"&&(0,t.jsx)("div",{className:"pb-2",children:(0,t.jsx)(en.Admonition,{title:"Empty organization",type:"warning",children:"This organization has no active projects. Did you select the correct organization?"})}),1===m.filter(e=>e.status===ei.PROJECT_STATUS.ACTIVE_HEALTHY||e.status===ei.PROJECT_STATUS.COMING_UP).length&&R?.planId==="pro"&&"upgrade"===z&&(0,t.jsx)("div",{className:"pb-2",children:(0,t.jsx)(en.Admonition,{type:"note",children:(0,t.jsxs)("div",{className:"text-sm prose",children:["First project included. Additional projects cost"," ",(0,t.jsx)("span",{translate:"no",children:"$10"}),"+/month regardless of activity."," ",(0,t.jsx)(eO.default,{href:`${N.DOCS_URL}/guides/platform/manage-your-usage/compute`,target:"_blank",className:"underline",children:"Learn more"})]})})}),(0,t.jsx)("div",{className:"flex space-x-2",children:(0,t.jsxs)(q.Button,{loading:B||I||K,disabled:n,type:"primary",onClick:V,className:"flex-1",size:"small",children:["Confirm ","downgrade"===z?"downgrade":"upgrade"]})})]})]}),(0,t.jsxs)("div",{className:"bg-surface-100 p-8 flex flex-col border-l xl:col-span-2",children:[(0,t.jsxs)("h3",{className:"mb-8",children:["downgrade"===z?"Downgrade":"Upgrade"," ",(0,t.jsx)("span",{className:"font-bold",children:S?.name})," to"," ","downgrade"===z?tP[e||"default"]:tw[e||"default"]]}),"downgrade"===z?J.length>0&&(0,t.jsxs)("div",{className:"mb-4",children:[(0,t.jsx)("h3",{className:"text-sm mb-1",children:"Features you'll lose"}),(0,t.jsx)("p",{className:"text-xs text-foreground-light mb-4",children:"Please review carefully before downgrading."}),(0,t.jsx)("div",{className:"space-y-2 mb-4 text-foreground-light",children:J.map(e=>(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("div",{className:"w-4",children:(0,t.jsx)(tS.InfoIcon,{className:"h-3 w-3 text-amber-900",strokeWidth:3})}),(0,t.jsx)("p",{className:"text-sm",children:"string"==typeof e?e:e[0]})]},"string"==typeof e?e:e[0]))})]}):W.length>0&&(0,t.jsxs)("div",{className:"mb-4",children:[(0,t.jsx)("h3",{className:"text-sm mb-4",children:"Upgrade features"}),(0,t.jsx)("div",{className:"space-y-2 mb-4 text-foreground-light",children:W.map(e=>(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("div",{className:"w-4",children:(0,t.jsx)(eX.Check,{className:"h-3 w-3 text-brand",strokeWidth:3})}),(0,t.jsxs)("div",{className:"text-sm",children:[(0,t.jsx)("p",{children:"string"==typeof e?e:e[0]}),Array.isArray(e)&&e.length>1&&(0,t.jsx)("p",{className:"text-foreground-lighter text-xs",children:e[1]})]})]},"string"==typeof e?e:e[0]))})]})]})]}),tC&&A&&(0,t.jsx)(x.Elements,{stripe:tC,options:D,children:(0,t.jsx)(a0.PaymentConfirmation,{paymentIntentSecret:A,onPaymentIntentConfirm:e=>Y(e),onLoadingChange:e=>k(e)})})]})})};var tA=e.i(702454),tE=e.i(600760);async function tI({orgSlug:e,prevPlan:a,currentPlan:t,reasons:s,message:i}){let{data:r,error:n}=await (0,_.post)("/platform/feedback/upgrade",{body:{...void 0!==e&&{orgSlug:e},...void 0!==a&&{prevPlan:a},...void 0!==t&&{currentPlan:t},reasons:s,...void 0!==i&&{additionalFeedback:i}}});return n&&(0,_.handleError)(n),r}let tk=({visible:e,originalPlan:a,subscription:r,onClose:n})=>{let{slug:l}=(0,i.useParams)(),[o,d]=(0,s.useState)(""),[c,u]=(0,s.useReducer)(function(e,a){return(0,tA.default)(e,a.target.value)?(0,tE.default)(e,a.target.value):[...e,a.target.value]},[]),m=(0,eK.generateUpgradeReasons)(a,r?.plan.id),{mutate:p,isPending:g}=(({onError:e,...a}={})=>(0,b.useMutation)({mutationFn:e=>tI(e),async onError(a,t,s){void 0===e?h.toast.error(`Failed to submit upgrade survey: ${a.message}`):e(a,t,s)},...a}))({onError:e=>{h.toast.error(`Failed to submit survey: ${e.message}`)},onSuccess:()=>{n(!0),window.scrollTo({top:0,left:0,behavior:"smooth"})}}),x=async()=>{if(0===c.length)return h.toast.error("Please select at least one reason for upgrading your subscription");p({orgSlug:l,prevPlan:a,currentPlan:r?.plan?.id,reasons:c,message:o.trim()||void 0})};return(0,t.jsx)(t.Fragment,{children:(0,t.jsx)(j.Modal,{alignFooter:"right",size:"xlarge",loading:g,visible:e,onCancel:n,onConfirm:x,cancelText:"Skip",header:"We're excited for your upgrade",children:(0,t.jsxs)(j.Modal.Content,{className:"space-y-4",children:[(0,t.jsx)("p",{className:"text-sm text-foreground-light",children:"What reasons motivated your decision to upgrade? Your feedback helps us improve Supabase as much as we can."}),(0,t.jsxs)("div",{className:"space-y-8 mt-6",children:[(0,t.jsx)("div",{className:"flex flex-wrap gap-2","data-toggle":"buttons",children:m.map(e=>{let a=c.find(a=>a===e);return(0,t.jsxs)("label",{className:`
                      flex cursor-pointer items-center space-x-2 rounded-md py-1 
                      pl-2 pr-3 text-center text-sm
                      shadow-sm transition-all duration-100
                      ${a?" bg-foreground text-background opacity-100 hover:bg-opacity-75":" bg-border-strong text-foreground opacity-25 hover:opacity-50"}
                  `,children:[(0,t.jsx)("input",{type:"checkbox",name:"options",value:e,className:"hidden",onClick:u}),(0,t.jsx)("div",{children:e})]},e)})}),(0,t.jsx)("div",{className:"text-area-text-sm",children:(0,t.jsx)(tb.Input.TextArea,{id:"message",name:"message",value:o,onChange:e=>d(e.target.value),label:"Anything else that we can improve on?"})})]})]})})})},tM=()=>{let e=(0,aY.useRouter)(),{slug:a}=(0,i.useParams)(),{data:r}=(0,o.useSelectedOrganizationQuery)(),{mutate:l}=(0,tu.useSendEventMutation)(),u=(0,s.useRef)(),[m,p]=(0,s.useState)(!1),[h,g]=(0,s.useState)(!1),[x,y]=(0,s.useState)(!1),[f,j]=(0,s.useState)(),{can:b}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.BILLING_WRITE,"stripe.subscriptions"),{data:_}=(0,td.useOrgProjectsInfiniteQuery)({slug:a}),v=(0,s.useMemo)(()=>_?.pages.flatMap(e=>e.projects),[_?.pages])||[],{data:S}=(({slug:e},{enabled:a=!0,...t}={})=>(0,T.useQuery)({queryKey:P.organizationKeys.detail(e),queryFn:({signal:a})=>to({slug:e},a),enabled:a&&void 0!==e,...t,staleTime:18e5}))({slug:a}),N=!!S?.has_oriole_project,C=aw(),w="subscriptionPlan"===C.panelKey,A=()=>{let{panel:a,...t}=e.query;e.push({pathname:e.pathname,query:t},void 0,{shallow:!0}),C.setPanelKey(void 0)},{data:I,isSuccess:k}=(0,n.useOrgSubscriptionQuery)({orgSlug:a}),{data:M,isPending:L}=(({orgSlug:e},{enabled:a=!0,...t}={})=>{let{can:s}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.BILLING_READ,"stripe.subscriptions");return(0,T.useQuery)({queryKey:aM.subscriptionKeys.orgPlans(e),queryFn:({signal:a})=>tc({orgSlug:e},a),enabled:a&&void 0!==e&&s,...t})})({orgSlug:a}),{data:F}=(0,tn.useFreeProjectLimitCheckQuery)({slug:a}),{data:D,error:z,isPending:R,isSuccess:O}=(({organizationSlug:e,tier:a},{enabled:t=!0,...s}={})=>(0,T.useQuery)({queryKey:P.organizationKeys.subscriptionPreview(e,a),queryFn:()=>tl({organizationSlug:e,tier:a}),enabled:t&&void 0!==e&&void 0!==a,...s}))({tier:f,organizationSlug:a}),U=M?.plans??[],B=(F||[]).length>0&&v.filter(e=>"INACTIVE"!==e.status&&"GOING_DOWN"!==e.status).length>0;(0,s.useEffect)(()=>{if(w){j(void 0);let t=Array.isArray(e.query.source)?e.query.source[0]:e.query.source,s={currentPlan:I?.plan?.name};t&&(s.origin=t),l({action:"studio_pricing_side_panel_opened",properties:s,groups:{organization:a??"Unknown"}})}},[w]),(0,s.useEffect)(()=>{w&&k&&(u.current=I.plan.id)},[w,k]);let $=f?U.find(e=>e.id===f.split("tier_")[1]):null;return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(aR.SidePanel,{hideFooter:!0,size:"xxlarge",visible:w,onCancel:()=>A(),header:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("h4",{children:["Change subscription plan for ",r?.name]}),(0,t.jsx)(q.Button,{asChild:!0,type:"default",icon:(0,t.jsx)(aj.ExternalLink,{}),children:(0,t.jsx)("a",{href:"https://supabase.com/pricing",target:"_blank",rel:"noreferrer",children:"Pricing"})})]}),children:[r&&r.managed_by!==ei.MANAGED_BY.SUPABASE&&(0,t.jsx)(ea.default,{managedBy:r.managed_by,resource:"Organization plans",cta:r.managed_by===ei.MANAGED_BY.VERCEL_MARKETPLACE?{installationId:r?.partner_id,path:"/settings",message:"Change Plan on Vercel Marketplace"}:r.managed_by===ei.MANAGED_BY.AWS_MARKETPLACE?{organizationSlug:r?.slug}:void 0}),(0,t.jsx)(aR.SidePanel.Content,{children:(0,t.jsx)("div",{className:"py-6 grid grid-cols-12 gap-3",children:tm.plans.map(s=>{let i=U.find(e=>e.id===s.id.split("tier_")[1]),n=i?.price??0,o="downgrade"===(0,ti.getPlanChangeType)(I?.plan.id,s?.planId),c=i?.id===I?.plan?.id,u=s.features,m=s.footer,p="log-drains-empty-state"===(Array.isArray(e.query.source)?e.query.source[0]:e.query.source)&&"tier_team"===s.id;return"tier_enterprise"===s.id?(0,t.jsx)(ty,{plan:s,isCurrentPlan:c},s.id):(0,t.jsxs)("div",{className:(0,d.cn)("px-4 py-4 flex flex-col items-start justify-between","border rounded-md col-span-12 md:col-span-4 bg-surface-200",p&&"ring-4 ring-brand animate-[pulse_1.5s_ease-in-out_1] shadow-md shadow-brand/40"),children:[(0,t.jsxs)("div",{className:"w-full",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)("p",{className:"text-brand-link text-sm uppercase",children:s.name}),c?(0,t.jsx)("div",{className:"text-xs bg-surface-300 text-foreground-light rounded px-2 py-0.5",children:"Current plan"}):s.nameBadge?(0,t.jsx)("div",{className:"text-xs bg-brand-300 dark:bg-brand-400 text-brand-600 rounded px-2 py-0.5",children:s.nameBadge}):null]}),(0,t.jsxs)("div",{className:"mt-4 flex items-center space-x-1 mb-4",children:[(n??0)>0&&(0,t.jsx)("p",{className:"text-foreground-light text-sm",children:"From"}),L?(0,t.jsx)("div",{className:"h-[28px] flex items-center justify-center",children:(0,t.jsx)(Q.ShimmeringLoader,{className:"w-[30px] h-[24px]"})}):(0,t.jsx)("p",{className:"text-foreground text-lg",translate:"no",children:(0,er.formatCurrency)(n)}),(0,t.jsx)("p",{className:"text-foreground-light text-sm",children:s.costUnit})]}),c?(0,t.jsx)(q.Button,{block:!0,disabled:!0,type:"default",children:"Current plan"}):b?(0,t.jsxs)(e_.ButtonTooltip,{block:!0,type:o?"default":"primary",disabled:I?.plan?.id==="enterprise"||I?.plan?.id==="platform"||r?.managed_by!==ei.MANAGED_BY.SUPABASE&&"tier_free"!==s.id||r?.managed_by===ei.MANAGED_BY.AWS_MARKETPLACE||N,onClick:()=>{j(s.id),l({action:"studio_pricing_plan_cta_clicked",properties:{selectedPlan:s.name,currentPlan:I?.plan?.name},groups:{organization:a??"Unknown"}})},tooltip:{content:{side:"bottom",className:N?"w-96 text-center":"",text:I?.plan?.id==="enterprise"||I?.plan?.id==="platform"?"Reach out to us via support to update your plan":N?"Your organization has projects that are using the OrioleDB extension which is only available on the Free plan. Remove all OrioleDB projects before changing your plan.":r?.managed_by===ei.MANAGED_BY.AWS_MARKETPLACE?"You cannot change the plan for an organization managed by AWS Marketplace":void 0}},children:[o?"Downgrade":"Upgrade"," to ",s.name]}):(0,t.jsx)(tr.RequestUpgradeToBillingOwners,{block:!0,plan:s.name}),(0,t.jsx)("div",{className:"border-t my-4"}),(0,t.jsx)("ul",{role:"list",children:u.map(e=>(0,t.jsxs)("li",{className:"flex py-2",children:[(0,t.jsx)("div",{className:"w-[12px]",children:(0,t.jsx)(eX.Check,{className:"h-3 w-3 text-brand translate-y-[2.5px]","aria-hidden":"true",strokeWidth:3})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"ml-3 text-xs text-foreground-light",children:"string"==typeof e?e:e[0]}),(0,ts.default)(e)&&(0,t.jsx)("p",{className:"ml-3 text-xs text-foreground-lighter",children:e[1]})]})]},"string"==typeof e?e:e[0]))})]}),m&&(0,t.jsx)("div",{className:"border-t pt-4 mt-4",children:(0,t.jsx)("p",{className:"text-foreground-light text-xs",children:m})})]},s.id)})})})]}),(0,t.jsx)(tx,{visible:"tier_free"===f,subscription:I,onClose:()=>j(void 0),onConfirm:()=>{j(void 0),B?y(!0):p(!0)},projects:v}),(0,t.jsx)(tT,{selectedTier:f,onClose:()=>j(void 0),planMeta:$,subscriptionPreviewError:z,subscriptionPreviewIsLoading:R,subscriptionPreviewInitialized:O,subscriptionPreview:D,subscription:I,projects:v,currentPlanMeta:{...U.find(e=>e.id===I?.plan?.id),features:tm.plans.find(e=>e.id===`tier_${I?.plan?.id}`)?.features||[]}}),(0,t.jsx)(tv,{visible:x,onClose:()=>y(!1)}),(0,t.jsx)(t_,{visible:m,projects:v,onClose:e=>{p(!1),e&&A()}}),(0,t.jsx)(tk,{visible:h,originalPlan:u.current,subscription:I,onClose:e=>{g(!1),e&&A()}})]})},tL=()=>{let{slug:e}=(0,i.useParams)(),a=aw(),s=(0,a_.useFlag)("disableProjectCreationAndUpdate"),{isSuccess:l,can:o}=(0,E.useAsyncCheckPermissions)(c.PermissionAction.BILLING_READ,"stripe.subscriptions"),{data:d,error:u,isPending:m,isError:p,isSuccess:h}=(0,n.useOrgSubscriptionQuery)({orgSlug:e},{enabled:o}),g=d?.plan,x=g?.name??"Unknown",y=!s&&!["enterprise","platform"].includes(g?.id??"");return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(r.ScaffoldSection,{children:[(0,t.jsx)("div",{className:"col-span-12 pb-2",children:(0,t.jsx)(tt.Restriction,{})}),(0,t.jsx)(r.ScaffoldSectionDetail,{children:(0,t.jsx)("div",{className:"sticky space-y-6 top-12",children:(0,t.jsxs)("div",{className:"space-y-2 mb-4",children:[(0,t.jsx)("p",{className:"text-foreground text-base m-0",children:"Subscription Plan"}),(0,t.jsx)("p",{className:"text-sm text-foreground-light m-0",children:"Each organization has it's own subscription plan, billing cycle, payment methods and usage quotas."})]})})}),(0,t.jsx)(r.ScaffoldSectionContent,{children:l&&!o?(0,t.jsx)(ee.default,{resourceText:"view this organization's subscription"}):(0,t.jsxs)(t.Fragment,{children:[m&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(Q.ShimmeringLoader,{}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-3/4"}),(0,t.jsx)(Q.ShimmeringLoader,{className:"w-1/2"})]}),p&&(0,t.jsx)(X.default,{subject:"Failed to retrieve subscription",error:u}),h&&(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsx)("div",{children:(0,t.jsxs)("p",{className:"text-2xl text-brand",children:[g?.name??"Unknown"," Plan"]})}),(0,t.jsxs)("div",{children:[y&&(0,t.jsx)(aE.default,{projectUpdateDisabled:s,children:(0,t.jsx)(q.Button,{type:"default",className:"pointer-events-auto",disabled:!y,onClick:()=>a.setPanelKey("subscriptionPlan"),children:"Change subscription plan"})}),!y&&(s?(0,t.jsx)(aP.Alert,{className:"mt-2",withIcon:!0,variant:"info",title:`Unable to update plan from ${x}`,children:"We have temporarily disabled project and subscription changes - our engineers are working on a fix."}):(0,t.jsx)(aP.Alert,{withIcon:!0,className:"mt-2",variant:"info",title:`Unable to update plan from ${x}`,actions:[(0,t.jsx)(q.Button,{asChild:!0,type:"default",children:(0,t.jsx)(H.SupportLink,{queryParams:{category:c.SupportCategories.SALES_ENQUIRY,subject:`Change plan away from ${x}`},children:"Contact support"})},"contact-support")],children:"Please contact us if you'd like to change your plan."}))]}),!d?.usage_billing_enabled&&(0,t.jsx)(en.Admonition,{type:"default",title:"This organization is limited by the included usage",children:(0,t.jsxs)("div",{className:"[&>p]:!leading-normal prose text-sm",children:["Projects may become unresponsive when this organization exceeds its"," ",(0,t.jsx)(eO.default,{href:`/org/${e}/usage`,children:"included usage quota"}),". To scale seamlessly,"," ",g?.id==="free"?"upgrade to a paid plan.":"you can disable Spend Cap under the Cost Control settings."]})})]})]})})]}),(0,t.jsx)(tM,{})]})},tF=()=>{let{billingAccountData:e,billingPaymentMethods:a,billingCredits:s,billingInvoices:i}=(0,l.useIsFeatureEnabled)(["billing:account_data","billing:payment_methods","billing:credits","billing:invoices"]),{data:c}=(0,o.useSelectedOrganizationQuery)(),{data:u}=(0,n.useOrgSubscriptionQuery)({orgSlug:c?.slug}),m=!u?.billing_via_partner,p=e&&m,h=a&&m;return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.ScaffoldContainerLegacy,{children:(0,t.jsx)(r.ScaffoldTitle,{children:"Billing"})}),(0,t.jsx)(r.ScaffoldContainer,{id:"subscription",className:(0,d.cn)("[&>div]:!pt-0"),children:(0,t.jsx)(tL,{})}),(0,t.jsx)(r.ScaffoldDivider,{}),(0,t.jsx)(r.ScaffoldContainer,{id:"cost-control",children:(0,t.jsx)(aB,{})}),(0,t.jsx)(r.ScaffoldDivider,{}),c&&"free"!==c.plan.id&&(0,t.jsx)(r.ScaffoldContainer,{id:"breakdown",children:(0,t.jsx)(eW,{})}),i&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.ScaffoldDivider,{}),(0,t.jsx)(r.ScaffoldContainer,{id:"invoices",children:(0,t.jsx)(eR,{})})]}),h&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.ScaffoldDivider,{}),(0,t.jsx)(r.ScaffoldContainer,{id:"payment-methods",children:(0,t.jsx)(eg,{})})]}),s&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.ScaffoldDivider,{}),(0,t.jsx)(r.ScaffoldContainer,{id:"credits-balance",children:(0,t.jsx)(ta,{})})]}),p&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.ScaffoldDivider,{}),(0,t.jsx)(r.ScaffoldContainer,{id:"email",children:(0,t.jsx)(af,{})}),(0,t.jsx)(r.ScaffoldDivider,{}),(0,t.jsx)(r.ScaffoldContainer,{id:"address",children:(0,t.jsx)(au,{})})]})]})};var tD=e.i(448710),tz=e.i(121958),tR=e.i(902780);let tO=()=>{let{panel:e,slug:a}=(0,i.useParams)(),r=aw(),n=(0,l.useIsFeatureEnabled)("billing:all");return((0,s.useEffect)(()=>{e&&"string"==typeof e&&["subscriptionPlan","costControl"].includes(e)&&(r.setPanelKey(e),document.getElementById("billing-page-top")?.scrollIntoView({behavior:"smooth"}))},[e]),n)?(0,t.jsx)(tF,{}):(0,t.jsx)(tR.UnknownInterface,{urlBack:`/org/${a}`})};tO.getLayout=e=>(0,t.jsx)(tD.default,{children:(0,t.jsx)(tz.default,{children:e})}),e.s(["default",0,tO],540901)},815779,(e,a,t)=>{let s="/org/[slug]/billing";(window.__NEXT_P=window.__NEXT_P||[]).push([s,()=>e.r(540901)]),a.hot&&a.hot.dispose(function(){window.__NEXT_P.push([s])})}]);

//# debugId=31acdf87-c12c-b919-c458-2d70f4a17688
//# sourceMappingURL=ea95db6e40ca8c74.js.map