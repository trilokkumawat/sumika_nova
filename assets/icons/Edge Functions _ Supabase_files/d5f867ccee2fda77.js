;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="9032162a-b9f5-f4d0-e660-caaafeb9d322")}catch(e){}}();
(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,879541,e=>{"use strict";var t=e.i(478902),n=e.i(902858),a=e.i(366652),s=e.i(271226),i=e.i(533488),r=e.i(389959),l=e.i(355901);e.i(128328);var o=e.i(158639),c=e.i(797691),d=e.i(215618),u=e.i(993463),h=e.i(567558),m=e.i(215312),x=e.i(300424),f=e.i(38429),p=e.i(356003),g=e.i(755216),j=e.i(246230),S=e.i(714403);async function _({projectRef:e,connectionString:t,func:n}){let{sql:a,zod:s}=g.default.functions.remove(n),{result:i}=await (0,S.executeSql)({projectRef:e,connectionString:t,sql:a,queryKey:["functions","delete",n.id.toString()]});return i}var y=e.i(869922),b=e.i(801834),N=e.i(2579),v=e.i(114378),C=e.i(983783),F=e.i(635494),w=e.i(392491),T=e.i(317040),I=e.i(441081),E=e.i(602089),A=e.i(627069),R=e.i(171997),D=e.i(492418),P=e.i(108151),L=e.i(892277),M=e.i(702454),k=e.i(964727),B=e.i(339098),$=e.i(816467),z=e.i(53071),Q=e.i(582391),V=e.i(291969),K=e.i(471998),O=e.i(211570),Y=e.i(210419),U=e.i(837710),q=e.i(874311);let H=({schema:e,filterString:a,isLocked:i,returnTypeFilter:r,securityFilter:l,duplicateFunction:o=k.default,editFunction:c=k.default,deleteFunction:u=k.default,functions:h})=>{let x=(0,s.useRouter)(),{data:f}=(0,F.useSelectedProjectQuery)(),p=(0,T.useAiAssistantStateSnapshot)(),{openSidebar:g}=(0,I.useSidebarManagerSnapshot)(),j=(h??[]).filter(e=>{let t=(0,M.default)(e.name.toLowerCase(),a.toLowerCase()),n=0===r.length||r.includes(e.return_type),s=0===l.length||l.includes("definer")&&e.security_definer||l.includes("invoker")&&!e.security_definer;return t&&n&&s}),S=(0,B.default)(j.filter(t=>t.schema==e),e=>e.name.toLocaleLowerCase()),_=f?.ref,{can:y}=(0,N.useAsyncCheckPermissions)(n.PermissionAction.TENANT_SQL_ADMIN_WRITE,"functions");return 0===S.length&&0===a.length?(0,t.jsx)(D.TableRow,{children:(0,t.jsxs)(D.TableCell,{colSpan:5,children:[(0,t.jsx)("p",{className:"text-sm text-foreground",children:"No functions created yet"}),(0,t.jsxs)("p",{className:"text-sm text-foreground-light",children:['There are no functions found in the schema "',e,'"']})]})},e):0===S.length&&a.length>0?(0,t.jsx)(D.TableRow,{children:(0,t.jsxs)(D.TableCell,{colSpan:5,children:[(0,t.jsx)("p",{className:"text-sm text-foreground",children:"No results found"}),(0,t.jsxs)("p",{className:"text-sm text-foreground-light",children:['Your search for "',a,'" did not return any results']})]})},e):(0,t.jsx)(t.Fragment,{children:S.map(n=>{let a="public"==e&&"trigger"!==n.return_type;return(0,t.jsxs)(D.TableRow,{children:[(0,t.jsx)(D.TableCell,{className:"truncate",children:(0,t.jsx)(U.Button,{type:"text",className:"text-link-table-cell text-sm disabled:opacity-100 disabled:no-underline p-0 hover:bg-transparent title",disabled:i||!y,onClick:()=>c(n),title:n.name,children:n.name})}),(0,t.jsx)(D.TableCell,{className:"table-cell",children:(0,t.jsx)("p",{title:n.argument_types,className:`truncate ${n.argument_types?"text-foreground-light":"text-foreground-muted"}`,children:n.argument_types||"â€“"})}),(0,t.jsx)(D.TableCell,{className:"table-cell",children:"trigger"===n.return_type?(0,t.jsx)(Y.default,{href:`/project/${_}/database/triggers?search=${n.name}`,className:"truncate text-link",title:n.return_type,children:n.return_type}):(0,t.jsx)("p",{title:n.return_type,className:"truncate text-foreground-light",children:n.return_type})}),(0,t.jsx)(D.TableCell,{className:"table-cell",children:(0,t.jsx)("p",{className:"truncate text-foreground-light",children:n.security_definer?"Definer":"Invoker"})}),(0,t.jsx)(D.TableCell,{className:"text-right",children:!i&&(0,t.jsx)("div",{className:"flex items-center justify-end",children:y?(0,t.jsxs)(q.DropdownMenu,{children:[(0,t.jsx)(q.DropdownMenuTrigger,{asChild:!0,children:(0,t.jsx)(U.Button,{"aria-label":"More options",type:"default",className:"px-1",icon:(0,t.jsx)(K.MoreVertical,{})})}),(0,t.jsxs)(q.DropdownMenuContent,{side:"left",className:"w-52",children:[a&&(0,t.jsxs)(q.DropdownMenuItem,{className:"space-x-2",onClick:()=>x.push(`/project/${_}/api?rpc=${n.name}`),children:[(0,t.jsx)(V.FileText,{size:14}),(0,t.jsx)("p",{children:"Client API docs"})]}),(0,t.jsx)(q.DropdownMenuSeparator,{}),(0,t.jsxs)(q.DropdownMenuItem,{className:"space-x-2",onClick:()=>c(n),children:[(0,t.jsx)(Q.Edit2,{size:14}),(0,t.jsx)("p",{children:"Edit function"})]}),(0,t.jsxs)(q.DropdownMenuItem,{className:"space-x-2",onClick:()=>{g(d.SIDEBAR_KEYS.AI_ASSISTANT),p.newChat({name:`Update function ${n.name}`,initialInput:"Update this function to do...",suggestions:{title:"I can help you make a change to this function, here are a few example prompts to get you started:",prompts:[{label:"Rename Function",description:"Rename this function to ..."},{label:"Modify Function",description:"Modify this function so that it ..."},{label:"Add Trigger",description:"Add a trigger for this function that calls it when ..."}]},sqlSnippets:[n.complete_statement]})},children:[(0,t.jsx)(z.Edit,{size:14}),(0,t.jsx)("p",{children:"Edit function with Assistant"})]}),(0,t.jsxs)(q.DropdownMenuItem,{className:"space-x-2",onClick:()=>o(n),children:[(0,t.jsx)($.Copy,{size:14}),(0,t.jsx)("p",{children:"Duplicate function"})]}),(0,t.jsx)(q.DropdownMenuSeparator,{}),(0,t.jsxs)(q.DropdownMenuItem,{className:"space-x-2",onClick:()=>u(n),children:[(0,t.jsx)(O.Trash,{size:14,className:"text-destructive"}),(0,t.jsx)("p",{children:"Delete function"})]})]})]}):(0,t.jsx)(m.ButtonTooltip,{disabled:!0,type:"default",icon:(0,t.jsx)(K.MoreVertical,{}),className:"px-1",tooltip:{content:{side:"left",text:"You need additional permissions to update functions"}}})})})]},n.id)})})};var W=e.i(198693),G=e.i(532728),X=e.i(666050),J=e.i(721329),Z=e.i(658036),ee=e.i(361288),et=e.i(667852),en=e.i(479232),ea=e.i(408891),es=e.i(417403),ei=e.i(707409),er=e.i(450972);async function el({projectRef:e,connectionString:t,payload:n}){let{sql:a,zod:s}=g.default.functions.create(n),{result:i}=await (0,S.executeSql)({projectRef:e,connectionString:t,sql:a,queryKey:["functions","create"]});return i}async function eo({projectRef:e,connectionString:t,func:n,payload:a}){let{sql:s,zod:i}=g.default.functions.update(n,a),{result:r}=await (0,S.executeSql)({projectRef:e,connectionString:t,sql:s,queryKey:["functions","update",n.id.toString()]});return r}var ec=e.i(412385),ed=e.i(24315),eu=e.i(215317),eh=e.i(61863),em=e.i(191209),ex=e.i(837243),ef=e.i(846887),ep=e.i(428353),eg=e.i(378277),ej=e.i(247114),eS=e.i(396831),e_=e.i(451031),ey=e.i(831927),eb=e.i(156722),eN=e.i(719754),ev=e.i(449123),eC=e.i(479095),eF=e.i(725137),ew=e.i(905596),eT=e.i(843778),eI=e.i(466472),eE=e.i(538482),eA=e.i(899320),eR=e.i(975924);let eD=({selectedFunction:e,isDuplicating:n})=>(0,t.jsx)(eF.SheetHeader,{className:"py-3 flex flex-row justify-between items-center border-b-0",children:(0,t.jsxs)("div",{className:"flex flex-row gap-3 items-center max-w-[75%]",children:[(0,t.jsxs)(eF.SheetClose,{className:(0,eT.cn)("text-muted hover:text ring-offset-background transition-opacity hover:opacity-100","focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2","disabled:pointer-events-none data-[state=open]:bg-secondary","transition"),children:[(0,t.jsx)(eR.X,{className:"h-3 w-3"}),(0,t.jsx)("span",{className:"sr-only",children:"Close"})]}),(0,t.jsx)(eF.SheetTitle,{className:"truncate",children:void 0!==e?n?"Duplicate function":`Edit '${e}' function`:"Add a new function"})]})});var eP=e.i(180148),eL=e.i(699879),eM=e.i(653961),ek=e.i(613580);let eB=({field:e,language:n,focused:a,setFocused:s})=>(0,t.jsxs)("div",{className:(0,eT.cn)("rounded-md relative group flex-grow"),children:[(0,t.jsx)(ed.FormControl_Shadcn_,{children:void 0!==n&&(0,t.jsx)(eM.default,{id:"database-functions-editor",language:"pgsql",placeholder:"plpgsql"===n?`BEGIN

END;`:void 0,value:e.value,onInputChange:e.onChange})}),(0,t.jsx)("div",{className:(0,eT.cn)("absolute top-0 right-2 bg-surface-300 border border-strong rounded h-[28px]","opacity-0 group-hover:opacity-100 group-hover:top-2 transition-all"),children:(0,t.jsxs)(ek.Tooltip,{children:[(0,t.jsx)(ek.TooltipTrigger,{asChild:!0,children:(0,t.jsx)(U.Button,{type:"text",size:"tiny",className:(0,eT.cn)("px-1.5 text-foreground-lighter hover:text-foreground","transition z-50"),onClick:()=>s(!a),icon:a?(0,t.jsx)(eL.Minimize2,{}):(0,t.jsx)(eP.Maximize2,{})})}),(0,t.jsx)(ek.TooltipContent,{side:"bottom",children:a?"Minimize editor":"Maximize editor"})]})})]}),e$="create-function-sidepanel",ez=es.default.object({name:es.default.string().trim().min(1),schema:es.default.string().trim().min(1),args:es.default.array(es.default.object({name:es.default.string().trim().min(1),type:es.default.string().trim()})),behavior:es.default.enum(["IMMUTABLE","STABLE","VOLATILE"]),definition:es.default.string().trim().min(1),language:es.default.string().trim(),return_type:es.default.string().trim(),security_definer:es.default.boolean(),config_params:es.default.array(es.default.object({name:es.default.string().trim().min(1),value:es.default.string().trim().min(1)})).optional()}),eQ=({func:e,visible:n,isDuplicating:a=!1,onClose:s})=>{let{data:i}=(0,F.useSelectedProjectQuery)(),[o,c]=(0,r.useState)(!1),[d,u]=(0,r.useState)(!1),h=!a&&!!e?.id,m=(0,ea.useForm)({resolver:(0,G.zodResolver)(ez)}),g=m.watch("language"),{confirmOnClose:S,modalProps:_}=(0,ec.useConfirmOnClose)({checkIsDirty:()=>m.formState.isDirty,onClose:s}),{mutate:y,isPending:b}=(({onSuccess:e,onError:t,...n}={})=>{let a=(0,p.useQueryClient)();return(0,f.useMutation)({mutationFn:e=>el(e),async onSuccess(t,n,s){let{projectRef:i}=n;await a.invalidateQueries({queryKey:j.databaseKeys.databaseFunctions(i)}),await e?.(t,n,s)},async onError(e,n,a){void 0===t?l.toast.error(`Failed to create database function: ${e.message}`):t(e,n,a)},...n})})(),{mutate:N,isPending:v}=(({onSuccess:e,onError:t,...n}={})=>{let a=(0,p.useQueryClient)();return(0,f.useMutation)({mutationFn:e=>eo(e),async onSuccess(t,n,s){let{projectRef:i}=n;await a.invalidateQueries({queryKey:j.databaseKeys.databaseFunctions(i)}),await e?.(t,n,s)},async onError(e,n,a){void 0===t?l.toast.error(`Failed to update database function: ${e.message}`):t(e,n,a)},...n})})(),C=async t=>{if(!i)return console.error("Project is required");let n={...t,args:t.args.map(e=>`${e.name} ${e.type}`),config_params:(0,ee.default)((0,Z.default)(t.config_params,"name"),"value")};h?N({func:e,projectRef:i.ref,connectionString:i.connectionString,payload:n},{onSuccess:()=>{l.toast.success(`Successfully updated function ${t.name}`),s()}}):y({projectRef:i.ref,connectionString:i.connectionString,payload:n},{onSuccess:()=>{l.toast.success(`Successfully created function ${t.name}`),s()}})};(0,r.useEffect)(()=>{n&&(u(!1),m.reset({name:e?.name??"",schema:e?.schema??"public",args:(0,eA.convertArgumentTypes)(e?.argument_types||"").value,behavior:e?.behavior??"VOLATILE",definition:e?.definition??"",language:e?.language??"plpgsql",return_type:e?.return_type??"void",security_definer:e?.security_definer??!1,config_params:(0,eA.convertConfigParams)(e?.config_params).value}))},[n,e?.id]);let{data:T}=(0,w.useProtectedSchemas)();return(0,t.jsx)(eF.Sheet,{open:n,onOpenChange:S,children:(0,t.jsxs)(eF.SheetContent,{showClose:!1,size:"default",className:"p-0 flex flex-row gap-0 !min-w-screen lg:!min-w-[600px]",children:[(0,t.jsxs)("div",{className:"flex flex-col grow w-full",children:[(0,t.jsx)(eD,{selectedFunction:e?.name,isDuplicating:a}),(0,t.jsx)(eC.Separator,{}),(0,t.jsx)(ep.Form_Shadcn_,{...m,children:(0,t.jsxs)("form",{id:e$,className:"flex-grow overflow-auto",onSubmit:m.handleSubmit(C),children:[(0,t.jsx)(eF.SheetSection,{className:d?"hidden":"",children:(0,t.jsx)(eh.FormField_Shadcn_,{control:m.control,name:"name",render:({field:e})=>(0,t.jsx)(eE.FormItemLayout,{label:"Name of function",description:"Name will also be used for the function name in postgres",layout:"horizontal",children:(0,t.jsx)(ed.FormControl_Shadcn_,{children:(0,t.jsx)(eg.Input_Shadcn_,{...e,placeholder:"Name of function"})})})})}),(0,t.jsx)(eC.Separator,{className:d?"hidden":""}),(0,t.jsxs)(eF.SheetSection,{className:d?"hidden":"space-y-4",children:[(0,t.jsx)(eh.FormField_Shadcn_,{control:m.control,name:"schema",render:({field:e})=>(0,t.jsx)(eE.FormItemLayout,{label:"Schema",description:"Tables made in the table editor will be in 'public'",layout:"horizontal",children:(0,t.jsx)(ed.FormControl_Shadcn_,{children:(0,t.jsx)(x.default,{selectedSchemaName:e.value,excludedSchemas:T?.map(e=>e.name),size:"small",onSelectSchema:t=>e.onChange(t)})})})}),!h&&(0,t.jsx)(eh.FormField_Shadcn_,{control:m.control,name:"return_type",render:({field:e})=>(0,t.jsx)(eE.FormItemLayout,{label:"Return type",layout:"horizontal",children:(0,t.jsxs)(ev.Select_Shadcn_,{onValueChange:e.onChange,defaultValue:e.value,children:[(0,t.jsx)(eb.SelectTrigger_Shadcn_,{className:"col-span-8",children:(0,t.jsx)(eN.SelectValue_Shadcn_,{})}),(0,t.jsx)(e_.SelectContent_Shadcn_,{children:(0,t.jsx)(eS.ScrollArea,{className:"h-52",children:["void","record","trigger","integer",...ei.POSTGRES_DATA_TYPES].map(e=>(0,t.jsx)(ey.SelectItem_Shadcn_,{value:e,children:e},e))})})]})})})]}),(0,t.jsx)(eC.Separator,{className:d?"hidden":""}),(0,t.jsx)(eF.SheetSection,{className:d?"hidden":"",children:(0,t.jsx)(eK,{readonly:h})}),(0,t.jsx)(eC.Separator,{className:d?"hidden":""}),(0,t.jsx)(eF.SheetSection,{className:`${d?"h-full":""} !px-0`,children:(0,t.jsx)(eh.FormField_Shadcn_,{control:m.control,name:"definition",render:({field:e})=>(0,t.jsxs)(em.FormItem_Shadcn_,{className:"space-y-4 flex flex-col h-full",children:[(0,t.jsxs)("div",{className:"px-content",children:[(0,t.jsx)(ex.FormLabel_Shadcn_,{className:"text-base text-foreground",children:"Definition"}),(0,t.jsxs)(eu.FormDescription_Shadcn_,{className:"text-sm text-foreground-light",children:[(0,t.jsxs)("p",{children:["The language below should be written in ",(0,t.jsx)("code",{children:g}),"."]}),!h&&(0,t.jsx)("p",{children:"Change the language in the Advanced Settings below."})]})]}),(0,t.jsx)("div",{className:(0,eT.cn)("border border-default flex",d?"flex-grow ":"h-72"),children:(0,t.jsx)(eB,{field:e,language:g,focused:d,setFocused:u})}),(0,t.jsx)(ef.FormMessage_Shadcn_,{className:"px-content"})]})})}),(0,t.jsx)(eC.Separator,{className:d?"hidden":""}),h?(0,t.jsx)(t.Fragment,{}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(eF.SheetSection,{className:d?"hidden":"",children:(0,t.jsx)("div",{className:"space-y-8 rounded bg-studio py-4 px-6 border border-overlay",children:(0,t.jsx)(ew.Toggle,{onChange:()=>c(!o),label:"Show advanced settings",checked:o,labelOptional:"These are settings that might be familiar for Postgres developers"})})}),o&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(eF.SheetSection,{className:d?"hidden":"space-y-2 pt-0",children:[(0,t.jsx)(eU,{}),(0,t.jsx)(eh.FormField_Shadcn_,{control:m.control,name:"behavior",render:({field:e})=>(0,t.jsx)(eE.FormItemLayout,{label:"Behavior",layout:"horizontal",children:(0,t.jsxs)(ev.Select_Shadcn_,{defaultValue:e.value,onValueChange:e.onChange,children:[(0,t.jsx)(eb.SelectTrigger_Shadcn_,{className:"col-span-8",children:(0,t.jsx)(eN.SelectValue_Shadcn_,{})}),(0,t.jsxs)(e_.SelectContent_Shadcn_,{children:[(0,t.jsx)(ey.SelectItem_Shadcn_,{value:"IMMUTABLE",children:"immutable"},"IMMUTABLE"),(0,t.jsx)(ey.SelectItem_Shadcn_,{value:"STABLE",children:"stable"},"STABLE"),(0,t.jsx)(ey.SelectItem_Shadcn_,{value:"VOLATILE",children:"volatile"},"VOLATILE")]})]})})})]}),(0,t.jsx)(eC.Separator,{className:d?"hidden":""}),(0,t.jsx)(eF.SheetSection,{className:d?"hidden":"",children:(0,t.jsx)(eO,{readonly:h})}),(0,t.jsx)(eC.Separator,{className:d?"hidden":""}),(0,t.jsxs)(eF.SheetSection,{className:d?"hidden":"",children:[(0,t.jsx)("h5",{className:"text-base text-foreground mb-4",children:"Type of Security"}),(0,t.jsx)(eh.FormField_Shadcn_,{control:m.control,name:"security_definer",render:({field:e})=>(0,t.jsxs)(em.FormItem_Shadcn_,{children:[(0,t.jsx)(ed.FormControl_Shadcn_,{className:"col-span-8",children:(0,t.jsxs)(ej.Radio.Group,{type:"cards",layout:"vertical",onChange:t=>e.onChange("SECURITY_DEFINER"==t.target.value),value:e.value?"SECURITY_DEFINER":"SECURITY_INVOKER",children:[(0,t.jsx)(ej.Radio,{id:"SECURITY_INVOKER",label:"SECURITY INVOKER",value:"SECURITY_INVOKER",checked:!e.value,description:(0,t.jsxs)(t.Fragment,{children:["Function is to be executed with the privileges of the user that ",(0,t.jsx)("span",{className:"text-foreground",children:"calls it"}),"."]})}),(0,t.jsx)(ej.Radio,{id:"SECURITY_DEFINER",label:"SECURITY DEFINER",value:"SECURITY_DEFINER",checked:e.value,description:(0,t.jsxs)(t.Fragment,{children:["Function is to be executed with the privileges of the user that ",(0,t.jsx)("span",{className:"text-foreground",children:"created it"}),"."]})})]})}),(0,t.jsx)(ef.FormMessage_Shadcn_,{})]})})]})]})]})]})}),(0,t.jsxs)(eF.SheetFooter,{children:[(0,t.jsx)(U.Button,{disabled:b||v,type:"default",onClick:S,children:"Cancel"}),(0,t.jsxs)(U.Button,{form:e$,htmlType:"submit",disabled:b||v,loading:b||v,children:[h?"Save":"Create"," function"]})]})]}),(0,t.jsx)(eV,{..._})]})})},eV=({visible:e,onClose:n,onCancel:a})=>(0,t.jsx)(eI.default,{visible:e,title:"Discard changes",confirmLabel:"Discard",onCancel:a,onConfirm:n,children:(0,t.jsx)("p",{className:"text-sm text-foreground-light",children:"There are unsaved changes. Are you sure you want to close the panel? Your changes will be lost."})}),eK=({readonly:e})=>{let{fields:n,append:a,remove:s}=(0,ea.useFieldArray)({name:"args"});return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"flex flex-col",children:[(0,t.jsx)("h5",{className:"text-base text-foreground",children:"Arguments"}),(0,t.jsx)("p",{className:"text-sm text-foreground-light",children:"Arguments can be referenced in the function body using either names or numbers."})]}),(0,t.jsxs)("div",{className:"space-y-2 pt-4",children:[e&&(0,X.default)(n)&&(0,t.jsx)("span",{className:"text-foreground-lighter",children:"No argument for this function"}),n.map((n,a)=>(0,t.jsxs)("div",{className:"flex flex-row space-x-1",children:[(0,t.jsx)(eh.FormField_Shadcn_,{name:`args.${a}.name`,render:({field:n})=>(0,t.jsxs)(em.FormItem_Shadcn_,{className:"flex-1",children:[(0,t.jsx)(ed.FormControl_Shadcn_,{children:(0,t.jsx)(eg.Input_Shadcn_,{...n,disabled:e,placeholder:"argument_name"})}),(0,t.jsx)(ef.FormMessage_Shadcn_,{})]})}),(0,t.jsx)(eh.FormField_Shadcn_,{name:`args.${a}.type`,render:({field:n})=>(0,t.jsxs)(em.FormItem_Shadcn_,{className:"flex-1",children:[(0,t.jsx)(ed.FormControl_Shadcn_,{children:e?(0,t.jsx)(eg.Input_Shadcn_,{value:n.value,disabled:!0,readOnly:!0,className:"h-auto"}):(0,t.jsx)(t.Fragment,{children:(0,t.jsxs)(ev.Select_Shadcn_,{disabled:e,onValueChange:n.onChange,defaultValue:n.value,children:[(0,t.jsx)(eb.SelectTrigger_Shadcn_,{className:"h-[38px]",children:(0,t.jsx)(eN.SelectValue_Shadcn_,{})}),(0,t.jsx)(e_.SelectContent_Shadcn_,{children:(0,t.jsx)(eS.ScrollArea,{className:"h-52",children:["integer",...ei.POSTGRES_DATA_TYPES].map(e=>(0,t.jsx)(ey.SelectItem_Shadcn_,{value:e,children:e},e))})})]})})}),(0,t.jsx)(ef.FormMessage_Shadcn_,{})]})}),!e&&(0,t.jsx)(U.Button,{type:"danger",icon:(0,t.jsx)(O.Trash,{size:12}),onClick:()=>s(a),className:"h-[38px] w-[38px]"})]},n.id)),!e&&(0,t.jsx)(U.Button,{type:"default",icon:(0,t.jsx)(en.Plus,{size:12}),onClick:()=>a({name:"",type:"integer"}),disabled:e,children:"Add a new argument"})]})]})},eO=({readonly:e})=>{let{fields:n,append:a,remove:s}=(0,ea.useFieldArray)({name:"config_params"});return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("h5",{className:"text-base text-foreground",children:"Configuration Parameters"}),(0,t.jsxs)("div",{className:"space-y-2 pt-4",children:[e&&(0,X.default)(n)&&(0,t.jsx)("span",{className:"text-foreground-lighter",children:"No argument for this function"}),n.map((n,a)=>(0,t.jsxs)("div",{className:"flex flex-row space-x-1",children:[(0,t.jsx)(eh.FormField_Shadcn_,{name:`config_params.${a}.name`,render:({field:e})=>(0,t.jsxs)(em.FormItem_Shadcn_,{className:"flex-1",children:[(0,t.jsx)(ed.FormControl_Shadcn_,{children:(0,t.jsx)(eg.Input_Shadcn_,{...e,placeholder:"parameter_name"})}),(0,t.jsx)(ef.FormMessage_Shadcn_,{})]})}),(0,t.jsx)(eh.FormField_Shadcn_,{name:`config_params.${a}.value`,render:({field:e})=>(0,t.jsxs)(em.FormItem_Shadcn_,{className:"flex-1",children:[(0,t.jsx)(ed.FormControl_Shadcn_,{children:(0,t.jsx)(eg.Input_Shadcn_,{...e,placeholder:"parameter_value"})}),(0,t.jsx)(ef.FormMessage_Shadcn_,{})]})}),!e&&(0,t.jsx)(U.Button,{type:"danger",icon:(0,t.jsx)(O.Trash,{size:12}),onClick:()=>s(a),className:"h-[38px] w-[38px]"})]},n.id)),!e&&(0,t.jsx)(U.Button,{type:"default",icon:(0,t.jsx)(en.Plus,{size:12}),onClick:()=>a({name:"",type:""}),disabled:e,children:"Add a new config"})]})]})},eY=["plpgsql","sql","plcoffee","plv8","plls"],eU=()=>{let{data:e}=(0,F.useSelectedProjectQuery)(),{data:n}=(0,er.useDatabaseExtensionsQuery)({projectRef:e?.ref,connectionString:e?.connectionString},{select:e=>(0,et.default)(e,e=>!(0,J.default)(e.installed_version))[0]}),a=(0,r.useMemo)(()=>eY.filter(e=>!e.startsWith("pl")||n?.find(t=>t.name===e)!==void 0),[n]);return(0,t.jsx)(eh.FormField_Shadcn_,{name:"language",render:({field:e})=>(0,t.jsx)(eE.FormItemLayout,{label:"Language",layout:"horizontal",children:(0,t.jsxs)(ev.Select_Shadcn_,{onValueChange:e.onChange,defaultValue:e.value,children:[(0,t.jsx)(eb.SelectTrigger_Shadcn_,{className:"col-span-8",children:(0,t.jsx)(eN.SelectValue_Shadcn_,{})}),(0,t.jsx)(e_.SelectContent_Shadcn_,{children:a.map(e=>(0,t.jsx)(ey.SelectItem_Shadcn_,{value:e,children:e},e))})]})})})};var eq=e.i(170149);let eH=({func:e,visible:n,setVisible:a,onDelete:s,isLoading:i})=>{let{data:r}=(0,F.useSelectedProjectQuery)(),{name:l,schema:o}=e??{};async function c(){return e?r?void s({func:e,projectRef:r.ref,connectionString:r.connectionString}):console.error("Project is required"):console.error("Function is required")}return(0,t.jsx)(eq.TextConfirmModal,{variant:"warning",visible:n,onCancel:()=>a(null),onConfirm:c,title:"Delete this function",loading:i,confirmLabel:`Delete function ${l}`,confirmPlaceholder:"Type in name of function",confirmString:l??"Unknown",text:(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("span",{children:"This will delete the function"})," ",(0,t.jsx)("span",{className:"text-bold text-foreground",children:l})," ",(0,t.jsx)("span",{children:"from the schema"})," ",(0,t.jsx)("span",{className:"text-bold text-foreground",children:o})]}),alert:{title:"You cannot recover this function once deleted."}})};var eW=e.i(931942);let eG=`create function function_name()
returns void
language plpgsql
as $$
begin
  -- Write your function logic here
end;
$$;`,eX=()=>{let e=(0,s.useRouter)(),{search:g}=(0,o.useParams)(),{data:S}=(0,F.useSelectedProjectQuery)(),M=(0,T.useAiAssistantStateSnapshot)(),{openSidebar:k}=(0,I.useSidebarManagerSnapshot)(),{selectedSchema:B,setSelectedSchema:$}=(0,C.useQuerySchemaState)(),z=(0,W.useIsInlineEditorEnabled)(),{setValue:Q,setTemplates:V,setInitialPrompt:K}=(0,eW.useEditorPanelStateSnapshot)(),O=(0,r.useRef)(null),Y=()=>{em(null),z?(K("Create a new database function that..."),Q(eG),V([]),k(d.SIDEBAR_KEYS.EDITOR_PANEL)):ed(!0)},U=g??"",[q,G]=(0,i.useQueryState)("return_type",(0,i.parseAsJson)(c.selectFilterSchema.parse)),[X,J]=(0,i.useQueryState)("security",(0,i.parseAsJson)(c.selectFilterSchema.parse)),Z=t=>{let n=new URL(document.URL);""===t?n.searchParams.delete("search"):n.searchParams.set("search",t),e.push(n)},{can:ee}=(0,N.useAsyncCheckPermissions)(n.PermissionAction.TENANT_SQL_ADMIN_WRITE,"functions"),{isSchemaLocked:et}=(0,w.useIsProtectedSchema)({schema:B});(0,b.useSchemasQuery)({projectRef:S?.ref,connectionString:S?.connectionString});let{data:en,error:ea,isPending:es,isError:ei}=(0,y.useDatabaseFunctionsQuery)({projectRef:S?.ref,connectionString:S?.connectionString}),er=(en??[]).filter(e=>e.schema===B),el=Array.from(new Set(er.map(e=>e.return_type))).sort(),eo=[...er.some(e=>e.security_definer)?[{label:"Definer",value:"definer"}]:[],...er.some(e=>!e.security_definer)?[{label:"Invoker",value:"invoker"}]:[]],[ec,ed]=(0,i.useQueryState)("new",i.parseAsBoolean.withDefault(!1).withOptions({history:"push",clearOnDefault:!0})),{setValue:eu,value:eh}=(0,v.useQueryStateWithSelect)({urlKey:"edit",select:e=>e?en?.find(t=>t.id.toString()===e):void 0,enabled:!!en,onError:()=>l.toast.error("Function not found")}),{setValue:em,value:ex}=(0,v.useQueryStateWithSelect)({urlKey:"duplicate",select:e=>{if(!e)return;let t=en?.find(t=>t.id.toString()===e);return t?{...t,name:`${t.name}_duplicate`}:void 0},enabled:!!en,onError:()=>l.toast.error("Function not found")}),{setValue:ef,value:ep}=(0,v.useQueryStateWithSelect)({urlKey:"delete",select:e=>e?en?.find(t=>t.id.toString()===e):void 0,enabled:!!en,onError:(e,t)=>(0,v.handleErrorOnDelete)(O,t,"Function not found")}),{mutate:eg,isPending:ej}=(({onSuccess:e,onError:t,...n}={})=>{let a=(0,p.useQueryClient)();return(0,f.useMutation)({mutationFn:e=>_(e),async onSuccess(t,n,s){let{projectRef:i}=n;await a.invalidateQueries({queryKey:j.databaseKeys.databaseFunctions(i)}),await e?.(t,n,s)},async onError(e,n,a){void 0===t?l.toast.error(`Failed to delete database function: ${e.message}`):t(e,n,a)},...n})})({onSuccess:(e,t)=>{l.toast.success(`Successfully removed function ${t.func.name}`),ef(null)},onError:()=>{O.current=null}});return es?(0,t.jsx)(P.GenericSkeletonLoader,{}):ei?(0,t.jsx)(h.default,{error:ea,subject:"Failed to retrieve database functions"}):(0,t.jsxs)(t.Fragment,{children:[0===(en??[]).length?(0,t.jsx)("div",{className:"flex h-full w-full items-center justify-center",children:(0,t.jsxs)(u.default,{title:"Functions",ctaButtonLabel:"Create a new function",onClickCta:()=>Y(),disabled:!ee,disabledMessage:"You need additional permissions to create functions",children:[(0,t.jsx)("p",{className:"text-sm text-foreground-light",children:"PostgreSQL functions, also known as stored procedures, is a set of SQL and procedural commands such as declarations, assignments, loops, flow-of-control, etc."}),(0,t.jsx)("p",{className:"text-sm text-foreground-light",children:"It's stored on the database server and can be invoked using the SQL interface."})]})}):(0,t.jsxs)("div",{className:"w-full space-y-4",children:[(0,t.jsxs)("div",{className:"flex flex-col lg:flex-row lg:items-center justify-between gap-2 flex-wrap",children:[(0,t.jsxs)("div",{className:"flex flex-col lg:flex-row lg:items-center gap-2",children:[(0,t.jsx)(x.default,{className:"w-full lg:w-[180px]",size:"tiny",showError:!1,selectedSchemaName:B,onSelectSchema:e=>{Z(""),setTimeout(()=>{$(e)},50)}}),(0,t.jsx)(R.Input,{placeholder:"Search for a function",size:"tiny",icon:(0,t.jsx)(a.Search,{}),value:U,className:"w-full lg:w-52",onChange:e=>Z(e.target.value)}),(0,t.jsx)(c.ReportsSelectFilter,{label:"Return Type",options:el.map(e=>({label:e,value:e})),value:q??[],onChange:G,showSearch:!0}),(0,t.jsx)(c.ReportsSelectFilter,{label:"Security",options:eo,value:X??[],onChange:J})]}),(0,t.jsx)("div",{className:"flex items-center gap-x-2",children:!et&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(m.ButtonTooltip,{disabled:!ee,onClick:()=>Y(),className:"flex-grow",tooltip:{content:{side:"bottom",text:ee?void 0:"You need additional permissions to create functions"}},children:"Create a new function"}),(0,t.jsx)(m.ButtonTooltip,{type:"default",disabled:!ee,className:"px-1 pointer-events-auto",icon:(0,t.jsx)(E.AiIconAnimation,{size:16}),onClick:()=>{k(d.SIDEBAR_KEYS.AI_ASSISTANT),M.newChat({name:"Create new function",initialInput:`Create a new function for the schema ${B} that does ...`})},tooltip:{content:{side:"bottom",text:ee?"Create with Supabase Assistant":"You need additional permissions to create functions"}}})]})})]}),et&&(0,t.jsx)(L.ProtectedSchemaWarning,{schema:B,entity:"functions"}),(0,t.jsx)(A.Card,{children:(0,t.jsxs)(D.Table,{className:"table-fixed overflow-x-auto",children:[(0,t.jsx)(D.TableHeader,{children:(0,t.jsxs)(D.TableRow,{children:[(0,t.jsx)(D.TableHead,{children:"Name"},"name"),(0,t.jsx)(D.TableHead,{className:"table-cell",children:"Arguments"},"arguments"),(0,t.jsx)(D.TableHead,{className:"table-cell",children:"Return type"},"return_type"),(0,t.jsx)(D.TableHead,{className:"table-cell w-[100px]",children:"Security"},"security"),(0,t.jsx)(D.TableHead,{className:"w-1/6"},"buttons")]})}),(0,t.jsx)(D.TableBody,{children:(0,t.jsx)(H,{schema:B,filterString:U,isLocked:et,returnTypeFilter:q??[],securityFilter:X??[],duplicateFunction:e=>{if(z){let t={...e,name:`${e.name}_duplicate`};K("Create new database function that..."),Q(t.complete_statement),V([]),k(d.SIDEBAR_KEYS.EDITOR_PANEL)}else em(e.id.toString())},editFunction:e=>{em(null),z?(Q(e.complete_statement),V([]),k(d.SIDEBAR_KEYS.EDITOR_PANEL)):eu(e.id.toString())},deleteFunction:e=>{ef(e.id.toString())},functions:en??[]})})]})})]}),(0,t.jsx)(eQ,{visible:ec,onClose:()=>{ed(!1)}}),(0,t.jsx)(eQ,{func:eh||ex,visible:!!eh||!!ex,onClose:()=>{eu(null),em(null)},isDuplicating:!!ex}),(0,t.jsx)(eH,{func:ep,visible:!!ep,setVisible:ef,onDelete:e=>{O.current=e.func.id.toString(),eg(e)},isLoading:ej})]})};var eJ=e.i(812136),eZ=e.i(448710),e0=e.i(513826),e1=e.i(693241),e2=e.i(10429),e8=e.i(127739),e3=e.i(456050),e4=e.i(228027);let e9=()=>{let{can:e,isSuccess:a}=(0,N.useAsyncCheckPermissions)(n.PermissionAction.TENANT_SQL_ADMIN_READ,"functions");return a&&!e?(0,t.jsx)(e1.default,{isFullPage:!0,resourceText:"view database functions"}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e3.PageHeader,{size:"large",children:(0,t.jsxs)(e3.PageHeaderMeta,{children:[(0,t.jsx)(e3.PageHeaderSummary,{children:(0,t.jsx)(e3.PageHeaderTitle,{children:"Database Functions"})}),(0,t.jsx)(e3.PageHeaderAside,{children:(0,t.jsx)(e0.DocsButton,{href:`${e2.DOCS_URL}/guides/database/functions`})})]})}),(0,t.jsx)(e8.PageContainer,{size:"large",children:(0,t.jsx)(e4.PageSection,{children:(0,t.jsx)(e4.PageSectionContent,{children:(0,t.jsx)(eX,{})})})})]})};e9.getLayout=e=>(0,t.jsx)(eZ.default,{children:(0,t.jsx)(eJ.default,{title:"Database",children:e})}),e.s(["default",0,e9],879541)},197853,(e,t,n)=>{let a="/project/[ref]/database/functions";(window.__NEXT_P=window.__NEXT_P||[]).push([a,()=>e.r(879541)]),t.hot&&t.hot.dispose(function(){window.__NEXT_P.push([a])})}]);

//# debugId=9032162a-b9f5-f4d0-e660-caaafeb9d322
//# sourceMappingURL=cde8c30302208ae5.js.map